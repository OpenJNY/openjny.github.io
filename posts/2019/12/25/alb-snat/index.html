<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Azure Load Balancer の SNAT がさっぱりわからん | $(ls /openjny/blog)</title>
    <meta name="description" content="OpenJNY&#39;s Blog">
    <link rel="icon" type="image/jpg" href="/img/favicon.png">
  <meta name="keywords" content="機械学習, ネットワーク, お笑い">
  <meta name="og:title" content="$(ls /openjny/blog)">
  <meta name="og:description" content="OpenJNY のブログです。技術的な内容から日常的なことまで。">
  <meta name="og:type" content="website">
  <meta name="og:url" content="https://openjny.github.io/">
  <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/mplus1p.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css">
    <link rel="preload" href="/assets/css/0.styles.bb124a8c.css" as="style"><link rel="preload" href="/assets/js/app.821993ad.js" as="script"><link rel="preload" href="/assets/js/6.da60bd61.js" as="script"><link rel="preload" href="/assets/js/17.bb5604b6.js" as="script"><link rel="prefetch" href="/assets/js/1.1b1bf802.js"><link rel="prefetch" href="/assets/js/10.8c6fbe21.js"><link rel="prefetch" href="/assets/js/11.eadad559.js"><link rel="prefetch" href="/assets/js/12.6534dd5b.js"><link rel="prefetch" href="/assets/js/13.842634ec.js"><link rel="prefetch" href="/assets/js/14.16635b1e.js"><link rel="prefetch" href="/assets/js/15.8b241f4f.js"><link rel="prefetch" href="/assets/js/16.d67d8c3c.js"><link rel="prefetch" href="/assets/js/18.426848b7.js"><link rel="prefetch" href="/assets/js/19.7762ce63.js"><link rel="prefetch" href="/assets/js/20.2ac9a129.js"><link rel="prefetch" href="/assets/js/21.fb01957d.js"><link rel="prefetch" href="/assets/js/22.0aea28c5.js"><link rel="prefetch" href="/assets/js/23.47ac0522.js"><link rel="prefetch" href="/assets/js/3.dab4048b.js"><link rel="prefetch" href="/assets/js/4.32c6ed03.js"><link rel="prefetch" href="/assets/js/5.e4585db8.js"><link rel="prefetch" href="/assets/js/7.62d67cb9.js"><link rel="prefetch" href="/assets/js/8.6ab3273d.js"><link rel="prefetch" href="/assets/js/9.56e78d39.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bb124a8c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/header/microsoft-windows-01.jpg);" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          $(ls /openjny/blog)
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Posts
          </a><a href="/about-me/" class="navbar-link" data-v-e4145d0a>
            About Me
          </a><a href="https://qiita.com/OpenJNY" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Qiita</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://github.com/OpenJNY/openjny.github.io/tree/vuepress" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Repo</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          Azure Load Balancer の SNAT がさっぱりわからん
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      作成日 : 2019-12-25
    </span> <span class="update-date" data-v-4e23451f>
      更新日 : 2019-12-29
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2019/12/23/ananta/" class="post-link" data-v-4e23451f>
      前の投稿 : Ananta: Azure を支えるステートフル L4 ロードバランサー
    </a> <a href="/posts/2019/12/27/hexo-docker/" class="post-link" data-v-4e23451f>
      次の投稿 : Hexo 執筆のための Docker 環境
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><p>この記事では、Azure Load Balancer の配下にある VM から、インターネットと通信したい時の話を取りあげます。
具体的には、いわゆる SNAT と呼ばれる仕組みで、Outbound 通信ができるパターンが LB の構成に依存していくつか存在するので、それを紹介します。</p> <p><img src="/img/microsoft-azure-01.jpg" alt=""></p> <p></p><div class="table-of-contents"><ul><li><a href="#背景">背景</a><ul><li><a href="#おさらい">おさらい</a></li></ul></li><li><a href="#_1-パブリック-ip-アドレスがある-vm-の場合">1. パブリック IP アドレスがある VM の場合</a></li><li><a href="#_2-パブリック-ip-アドレスがない-vm-の場合">2. パブリック IP アドレスがない VM の場合</a><ul><li><a href="#azure-既定の-snat">Azure 既定の SNAT</a></li><li><a href="#送信不可">送信不可</a></li><li><a href="#外部-lb-の-snat">外部 LB の SNAT</a></li><li><a href="#外部-lb-の-snat-送信規則">外部 LB の SNAT + 送信規則</a></li></ul></li><li><a href="#まとめ">まとめ</a></li></ul></div><p></p> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>実の所このドキュメントに全部書いてあります。・・・・ただ、長い・・・<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p> <div class="custom-block reference"><p><strong>Azure の Outbound connections - Azure Load Balancer | Microsoft Docs</strong> <a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><p>本稿は、上の内容を「<strong>概要をぱっと速く掴みたい人</strong>」向けにざっくりまとめたものです。</p> <h3 id="おさらい"><a href="#おさらい" class="header-anchor">#</a> おさらい</h3> <p>本筋の前に、簡単に LB と VM の関係や、LB の SKU について確認しておきます。</p> <ul><li>Load Balancer には <strong>内部/パブリック</strong> という種類がある<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>。
<ul><li><strong>パブリック ロードバランサー (Public Load Balancer)</strong> は、すべてのフロントエンドが「パブリック IP アドレスのグローバル IP アドレス」で構成されている LB のことです。歴史的経緯から「外部 LB」と呼ぶこともあり、名称が短いという単純な理由で本稿では「外部 LB」と呼ぶことにします。</li> <li><strong>内部ロードバランサー (Internal Load Balancer; ILB)</strong> は、すべてのフロントエンドが「仮想ネットワーク内のプライベート IP アドレス」で構成されている LB のこと。</li></ul></li> <li>Load Balancer の SKU には <strong>Basic/Standard</strong> がある<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。
<ul><li>種類とは独立した概念です</li> <li>例) Basic SKU の内部 LB、Basic SKU の外部 LB</li></ul></li> <li>VM は次のいずれかのパターンで LB に組み込める
<ul><li>一つの内部 LB にだけ所属</li> <li>一つの外部 LB にだけ所属</li> <li>一つの内部 LB と一つの外部 LB の両方に所属 ※この時、両 LB の SKU が揃っている必要があります<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>。</li></ul></li></ul> <h2 id="_1-パブリック-ip-アドレスがある-vm-の場合"><a href="#_1-パブリック-ip-アドレスがある-vm-の場合" class="header-anchor">#</a> 1. パブリック IP アドレスがある VM の場合</h2> <p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/127839/312074e5-7463-aa1a-1a7f-859ca7cb529f.png" alt="image.png"></p> <p><strong>VM に関連付けられたパブリック IP アドレス (PIP) が存在する場合、LB の構成に関わらず、必ず PIP を利用して SNAT します。</strong></p> <p><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections" target="_blank" rel="noopener noreferrer">上記ドキュメント<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>では<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#ilpip" target="_blank" rel="noopener noreferrer">「シナリオ 1」<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>に該当する構成パターンです。</p> <p>以下で登場する他の構成パターンと異なり、<strong>パブリック IP のすべてのエフェメラル ポートを使用できる</strong>というメリットがあります。
ただ、デメリットとして PIP による金銭的コストの増加や、ファイアウォールの管理コストの増加等の影響があるので注意してください。</p> <p>参考: <a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#assignilpip" target="_blank" rel="noopener noreferrer">各 VM にパブリック IP を割り当てる | Microsoft Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_2-パブリック-ip-アドレスがない-vm-の場合"><a href="#_2-パブリック-ip-アドレスがない-vm-の場合" class="header-anchor">#</a> 2. パブリック IP アドレスがない VM の場合</h2> <p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/127839/10498ab8-a4d0-67f9-db06-d595e105fd35.png" alt="image.png"></p> <p>パターンは 4 つですね。</p> <ul><li>Azure 既定の SNAT</li> <li>送信不可</li> <li>外部 LB の SNAT</li> <li>外部 LB の SNAT + 送信規則</li></ul> <h3 id="azure-既定の-snat"><a href="#azure-既定の-snat" class="header-anchor">#</a> Azure 既定の SNAT</h3> <p><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#defaultsnat" target="_blank" rel="noopener noreferrer">上記ドキュメントの「シナリオ 3」<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>に相当する状況。
VM のデプロイされた <strong>Azure リージョンで使われる &quot;任意のグローバル IP アドレス&quot;<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup> を利用して SNAT</strong> されます。</p> <p>Download Azure IP Ranges and Service Tags – Public Cloud from Official Microsoft Download Center
<a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519" target="_blank" rel="noopener noreferrer">https://www.microsoft.com/en-us/download/details.aspx?id=56519<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>注意事項としては、<strong>送信フロー毎に利用される IP アドレスが変わる</strong>こと。
例えばファイアウォールなどでホワイトリストしたり、サーバー側でクライアントの IP アドレスを利用するシナリオ等で注意が必要です。</p> <h3 id="送信不可"><a href="#送信不可" class="header-anchor">#</a> 送信不可</h3> <p>(パブリック IP アドレスもなく、外部 LB の配下にもいない VM が) <strong>Standard SKU の内部 LB の配下にいる場合は、外部と通信できません</strong><sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>。</p> <h3 id="外部-lb-の-snat"><a href="#外部-lb-の-snat" class="header-anchor">#</a> 外部 LB の SNAT</h3> <p><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#lb" target="_blank" rel="noopener noreferrer">上記ドキュメントの「シナリオ 2」<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>に相当する状況。</p> <p><strong>外部 Load Balancer のフロントエンドに付与したパブリック IP アドレスを利用して SNAT される</strong>。そのため、SNAT で利用する IP アドレスが (一般に複数ではあるものの) 固定されているのが特徴。</p> <p>このシナリオには、結構引っかかりやすい落とし穴がいくつかあるので要注意。</p> <h4 id="注意-1-負荷分散規則を作って初めて-snat-出来るようになる"><a href="#注意-1-負荷分散規則を作って初めて-snat-出来るようになる" class="header-anchor">#</a> 注意 1: 負荷分散規則を作って初めて SNAT 出来るようになる</h4> <p>Basic SKU の場合、TCP/UDP のどちらの負荷分散規則でも良いので、SNAT したい ipconfig に対する負荷分散規則を作成している必要がある。</p> <p>■ Azure の Outbound connections - Azure Load Balancer | Microsoft Docs
<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>Basic SKU の SNAT では、負荷分散規則で指定されたトランスポート プロトコルに関係なく、常に両方の IP トランスポート プロトコルに対して SNAT がプログラムされます。</p></blockquote> <h4 id="注意-2-ipconfig-ごとに任意のエフェメラル-ポートが使える訳ではない"><a href="#注意-2-ipconfig-ごとに任意のエフェメラル-ポートが使える訳ではない" class="header-anchor">#</a> 注意 2: ipconfig ごとに任意のエフェメラル ポートが使える訳ではない</h4> <p>以下の公式ドキュメントに定義されているように、ipconfig ごとが利用できる SNAT ポート数 (i.e. 同時に張れる Outbound TCP コネクション数) は予め決まっている。</p> <p>■ Azure の Outbound connections - Azure Load Balancer | Microsoft Docs
<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。
(表略)</p></blockquote> <h3 id="外部-lb-の-snat-送信規則"><a href="#外部-lb-の-snat-送信規則" class="header-anchor">#</a> 外部 LB の SNAT + 送信規則</h3> <p>これも<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#lb" target="_blank" rel="noopener noreferrer">ドキュメントの「シナリオ 2」<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>に相当する状況で、基本は「外部 LB の SNAT」と同じだけど、<strong>さらに送信規則によって SNAT をコントロール出来る</strong>パターン。</p> <p>&quot;基本は&quot; と述べたのは、<strong>「外部 LB の SNAT」とは 注意 1 についての仕様が少し違う</strong>から。具体的には次の通り。</p> <ul><li>負荷分散規則を構成して初めて SNAT 出来る点は、Basic も Standard も変わらない</li> <li>Standard SKU の場合は、TCP の SNAT なら TCP の負荷分散規則が、UDP の SNAT なら UDP の負荷分散規則が、といった風に<strong>プロトコル毎の規則作成が必要</strong>となる。</li></ul> <p>■ Azure の Outbound connections - Azure Load Balancer | Microsoft Docs
<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-connections#preallocatedports<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>重要
Standard SKU の SNAT プログラミングは、IP トランスポート プロトコルに従い、負荷分散規則から派生します。 TCP 負荷分散規則だけが存在する場合、SNAT は TCP でのみ使用できます。 TCP 負荷分散規則しかないときに、UDP の送信 SNAT が必要な場合は、同じフロントエンドから同じバックエンド プールへの UDP 負荷分散規則を作成します。 これにより、UDP の SNAT プログラミングがトリガーされます。 動作規則や正常性プローブは不要です。</p></blockquote> <h4 id="送信規則"><a href="#送信規則" class="header-anchor">#</a> 送信規則</h4> <p>この構成パターンの最大の特徴は、<strong>送信規則 (outbound rule)</strong> と呼ばれる、Standard 外部 LB 特有の機能が利用できること。
送信規則は、<strong>Basic SKU での [注意 2] の制限を緩和する</strong>目的で利用され、その概要や構成方法については以下の公式ドキュメントで詳細に記述されている。</p> <p>■ アウトバウンド規則 - Azure Load Balancer | Microsoft Docs
<a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-rules-overview" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-outbound-rules-overview<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>細かいところを網羅しなければならないという、ドキュメントに課せられた要請上、仕方がない点です。 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li> <li id="fn2" class="footnote-item"><p><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-overview#load-balancer-types" target="_blank" rel="noopener noreferrer">Azure Load Balancer の概要 - Azure Load Balancer | Microsoft Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref2" class="footnote-backref">↩︎</a></p></li> <li id="fn3" class="footnote-item"><p><a href="https://docs.microsoft.com/ja-jp/azure/load-balancer/load-balancer-standard-overview#what-is-standard-load-balancer" target="_blank" rel="noopener noreferrer">Azure Standard Load Balancer とは - Azure Load Balancer | Microsoft Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref3" class="footnote-backref">↩︎</a></p></li> <li id="fn4" class="footnote-item"><p><a href="https://blogs.technet.microsoft.com/jpaztech/2019/01/29/azurelb-tips/#cannot-add-vm" target="_blank" rel="noopener noreferrer">Azure ロードバランサー利用時の注意点 – Japan Azure IaaS Support Blog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref4" class="footnote-backref">↩︎</a></p></li> <li id="fn5" class="footnote-item"><p>なお、グローバル IP アドレスの一覧は、以下のページからダウンロード出来ます。 <a href="#fnref5" class="footnote-backref">↩︎</a></p></li> <li id="fn6" class="footnote-item"><p><a href="https://blogs.technet.microsoft.com/jpaztech/2019/01/29/azurelb-tips/#outbound-cannot-connect" target="_blank" rel="noopener noreferrer">Azure ロードバランサー利用時の注意点 – Japan Azure IaaS Support Blog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="#fnref6" class="footnote-backref">↩︎</a></p></li></ol></section></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      作成日 : 2019-12-25
    </span> <span class="update-date" data-v-4e23451f>
      更新日 : 2019-12-29
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2019/12/23/ananta/" class="post-link" data-v-4e23451f>
      前の投稿 : Ananta: Azure を支えるステートフル L4 ロードバランサー
    </a> <a href="/posts/2019/12/27/hexo-docker/" class="post-link" data-v-4e23451f>
      次の投稿 : Hexo 執筆のための Docker 環境
    </a></section></section> <!----></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" data-v-9d847660><img src="https://pbs.twimg.com/profile_images/845174054273236993/aYDqys_v_400x400.jpg" alt="OpenJNY" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      OpenJNY
    </section> <section class="info-desc" data-v-9d847660>Laugh and grow fat :D</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Tokyo, Japan" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Tokyo, Japan</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Tokyo, Japan
        </span></span></section> <!----> <section data-v-9d847660><a href="mailto:openjny@gmail.com" title="openjny@gmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>openjny@gmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          openjny@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://twitter.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="Twitter: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Twitter: openjny</title><use xlink:href="#icon-twitter" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://github.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: openjny</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://www.linkedin.com/in/ja-junya-yamaguchi" target="_blank" class="sns-link" data-v-9d847660><span title="LinkedIn: junya-yamaguchi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>LinkedIn: junya-yamaguchi</title><use xlink:href="#icon-linkedin" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://gitlab.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="GitLab: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitLab: openjny</title><use xlink:href="#icon-gitlab" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://bitbucket.org/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="Bitbucket: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Bitbucket: openjny</title><use xlink:href="#icon-bitbucket" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>目次</span> <div class="post-nav-toc"><ul><li><a href="/posts/2019/12/25/alb-snat/#背景">背景</a><ul><li><a href="/posts/2019/12/25/alb-snat/#おさらい">おさらい</a></li></ul></li><li><a href="/posts/2019/12/25/alb-snat/#_1-パブリック-ip-アドレスがある-vm-の場合">1. パブリック IP アドレスがある VM の場合</a></li><li><a href="/posts/2019/12/25/alb-snat/#_2-パブリック-ip-アドレスがない-vm-の場合">2. パブリック IP アドレスがない VM の場合</a><ul><li><a href="/posts/2019/12/25/alb-snat/#azure-既定の-snat">Azure 既定の SNAT</a></li><li><a href="/posts/2019/12/25/alb-snat/#送信不可">送信不可</a></li><li><a href="/posts/2019/12/25/alb-snat/#外部-lb-の-snat">外部 LB の SNAT</a></li><li><a href="/posts/2019/12/25/alb-snat/#外部-lb-の-snat-送信規則">外部 LB の SNAT + 送信規則</a></li></ul></li><li><a href="/posts/2019/12/25/alb-snat/#まとめ">まとめ</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://twitter.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="Twitter: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Twitter: openjny</title><use xlink:href="#icon-twitter" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://github.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: openjny</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://www.linkedin.com/in/ja-junya-yamaguchi" target="_blank" class="sns-link" data-v-1375e54c><span title="LinkedIn: junya-yamaguchi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>LinkedIn: junya-yamaguchi</title><use xlink:href="#icon-linkedin" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://gitlab.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="GitLab: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitLab: openjny</title><use xlink:href="#icon-gitlab" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://bitbucket.org/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="Bitbucket: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Bitbucket: openjny</title><use xlink:href="#icon-bitbucket" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <!----></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.821993ad.js" defer></script><script src="/assets/js/6.da60bd61.js" defer></script><script src="/assets/js/17.bb5604b6.js" defer></script>
  </body>
</html>
