<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[bpf-perf-workshop] lab2: SSH ログイン パフォーマンス | $(ls /openjny/blog)</title>
    <meta name="description" content="OpenJNY&#39;s Blog">
    <link rel="icon" type="image/jpg" href="/img/favicon.png">
  <meta name="keywords" content="機械学習, ネットワーク, お笑い">
  <meta name="og:title" content="$(ls /openjny/blog)">
  <meta name="og:description" content="OpenJNY のブログです。技術的な内容から日常的なことまで。">
  <meta name="og:type" content="website">
  <meta name="og:url" content="https://openjny.github.io/">
  <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/mplus1p.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css">
    <link rel="preload" href="/assets/css/0.styles.bb124a8c.css" as="style"><link rel="preload" href="/assets/js/app.c2a58a0d.js" as="script"><link rel="preload" href="/assets/js/6.da60bd61.js" as="script"><link rel="preload" href="/assets/js/23.4edff57c.js" as="script"><link rel="prefetch" href="/assets/js/1.1b1bf802.js"><link rel="prefetch" href="/assets/js/10.8c6fbe21.js"><link rel="prefetch" href="/assets/js/11.eadad559.js"><link rel="prefetch" href="/assets/js/12.6534dd5b.js"><link rel="prefetch" href="/assets/js/13.842634ec.js"><link rel="prefetch" href="/assets/js/14.16635b1e.js"><link rel="prefetch" href="/assets/js/15.8b241f4f.js"><link rel="prefetch" href="/assets/js/16.d67d8c3c.js"><link rel="prefetch" href="/assets/js/17.bb5604b6.js"><link rel="prefetch" href="/assets/js/18.426848b7.js"><link rel="prefetch" href="/assets/js/19.7762ce63.js"><link rel="prefetch" href="/assets/js/20.2ac9a129.js"><link rel="prefetch" href="/assets/js/21.493696c1.js"><link rel="prefetch" href="/assets/js/22.e2dffe76.js"><link rel="prefetch" href="/assets/js/24.4a8facec.js"><link rel="prefetch" href="/assets/js/25.da16e18f.js"><link rel="prefetch" href="/assets/js/26.1809ab3e.js"><link rel="prefetch" href="/assets/js/3.dab4048b.js"><link rel="prefetch" href="/assets/js/4.32c6ed03.js"><link rel="prefetch" href="/assets/js/5.e4585db8.js"><link rel="prefetch" href="/assets/js/7.62d67cb9.js"><link rel="prefetch" href="/assets/js/8.6ab3273d.js"><link rel="prefetch" href="/assets/js/9.56e78d39.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bb124a8c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          $(ls /openjny/blog)
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Posts
          </a><a href="/about-me/" class="navbar-link" data-v-e4145d0a>
            About Me
          </a><a href="https://qiita.com/OpenJNY" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Qiita</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://github.com/OpenJNY/openjny.github.io/tree/vuepress" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Repo</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          [bpf-perf-workshop] lab2: SSH ログイン パフォーマンス
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      作成日 : 2021-05-18
    </span> <span class="update-date" data-v-4e23451f>
      更新日 : 2021-05-20
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2021/05/13/bpf-perf-workshop-lab1/" class="post-link" data-v-4e23451f>
      前の投稿 : [bpf-perf-workshop] lab1: レイテンシ調査
    </a> <!----></section></section> <article class="main-div"><div class="post-content content content__default"><p>Brendan Gregg 氏のハンズオン ワークショップ &quot;bpf-perf-workshop&quot; より、SSH 経由のコマンドのパフォーマンスに関する課題 &quot;lab2&quot; をやってみました。</p> <p></p><div class="table-of-contents"><ul><li><a href="#課題">課題</a></li><li><a href="#ラボ環境のセットアップ">ラボ環境のセットアップ</a></li><li><a href="#before-ssh-経由コマンドのレイテンシ計測">Before: ssh 経由コマンドのレイテンシ計測</a></li><li><a href="#調査方針">調査方針</a></li><li><a href="#ログの収集">ログの収集</a><ul><li><a href="#採取後の整形">採取後の整形</a></li></ul></li><li><a href="#分析">分析</a><ul><li><a href="#cpu-観点での調査">CPU 観点での調査</a></li><li><a href="#メモリ観点の調査">メモリ観点の調査</a></li><li><a href="#ファイルシステム、i-o-観点の調査">ファイルシステム、I/O 観点の調査</a></li><li><a href="#ネットワーク観点の調査">ネットワーク観点の調査</a></li><li><a href="#一次見解">一次見解</a></li></ul></li><li><a href="#対応策">対応策</a><ul><li><a href="#after-ssh-経由コマンドのレイテンシ計測">After: ssh 経由コマンドのレイテンシ計測</a></li></ul></li><li><a href="#まとめ">まとめ</a></li></ul></div><p></p> <h2 id="課題"><a href="#課題" class="header-anchor">#</a> 課題</h2> <p>今回の問題はこちら。</p> <p><a href="https://github.com/brendangregg/bpf-perf-workshop/blob/master/lab2.md" target="_blank" rel="noopener noreferrer">bpf-perf-workshop/lab2.md at master · brendangregg/bpf-perf-workshop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>Problem Statement
Under load, it can take a few seconds to login to your lab system via SSH. Even when idle, it can take 1-2 seconds. Why does it take this long on an idle system, and how can this login time be reduced?</p></blockquote> <p>負荷の高いシステムに SSH ログインするとき、ログインに時間がかかる (数秒要することもある) のはなぜ? という課題。</p> <h2 id="ラボ環境のセットアップ"><a href="#ラボ環境のセットアップ" class="header-anchor">#</a> ラボ環境のセットアップ</h2> <p>この課題は、負荷の高い (under load と表現される) ラボ環境を用意するところから始めなければならない。</p> <p>&quot;負荷&quot; が意味するところがわからず戸惑ったが、ワークショップのスライドの文脈を読み解くに、おそらく <code>lab001</code> を実行させた状態を under load を言っているに違いない。ということで、I/O 負荷を発生させる。なんとなく、<code>lab001</code> を 2 つ起動させてみた。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>root@vm-ubuntu: ~<span class="token comment"># ./bpf-perf-workshop/lab001 &amp;</span>
root@vm-ubuntu: ~<span class="token comment"># ./bpf-perf-workshop/lab001 &amp;</span>
</code></pre></div><p>いい感じに負荷みを感じている。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>root@vm-ubuntu:~<span class="token comment"># uptime</span>
 <span class="token number">13</span>:37:40 up  <span class="token number">4</span>:23,  <span class="token number">6</span> users,  load average: <span class="token number">3.00</span>, <span class="token number">2.98</span>, <span class="token number">2.68</span>
root@vm-ubuntu:~<span class="token comment"># cat /proc/pressure/io</span>
some <span class="token assign-left variable">avg10</span><span class="token operator">=</span><span class="token number">73.11</span> <span class="token assign-left variable">avg60</span><span class="token operator">=</span><span class="token number">70.48</span> <span class="token assign-left variable">avg300</span><span class="token operator">=</span><span class="token number">72.26</span> <span class="token assign-left variable">total</span><span class="token operator">=</span><span class="token number">11215650634</span>
full <span class="token assign-left variable">avg10</span><span class="token operator">=</span><span class="token number">73.10</span> <span class="token assign-left variable">avg60</span><span class="token operator">=</span><span class="token number">70.40</span> <span class="token assign-left variable">avg300</span><span class="token operator">=</span><span class="token number">72.17</span> <span class="token assign-left variable">total</span><span class="token operator">=</span><span class="token number">11194499828</span>
root@vm-ubuntu:~<span class="token comment"># vmstat -S M 1</span>
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   <span class="token function">free</span>   buff  cache   si   so    bi    bo   <span class="token keyword">in</span>   cs us sy <span class="token function">id</span> wa st
 <span class="token number">2</span>  <span class="token number">1</span>      <span class="token number">0</span>  <span class="token number">14816</span>    <span class="token number">100</span>    <span class="token number">791</span>    <span class="token number">0</span>    <span class="token number">0</span>    <span class="token number">10</span>   <span class="token number">680</span>  <span class="token number">124</span>  <span class="token number">404</span>  <span class="token number">0</span>  <span class="token number">1</span> <span class="token number">93</span>  <span class="token number">6</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">1</span>      <span class="token number">0</span>  <span class="token number">14816</span>    <span class="token number">100</span>    <span class="token number">791</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">3824</span>  <span class="token number">579</span> <span class="token number">1960</span>  <span class="token number">0</span>  <span class="token number">1</span> <span class="token number">97</span>  <span class="token number">2</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">1</span>      <span class="token number">0</span>  <span class="token number">14816</span>    <span class="token number">100</span>    <span class="token number">791</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">3920</span>  <span class="token number">619</span> <span class="token number">2020</span>  <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">98</span>  <span class="token number">2</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">1</span>      <span class="token number">0</span>  <span class="token number">14816</span>    <span class="token number">100</span>    <span class="token number">791</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">1920</span>  <span class="token number">741</span> <span class="token number">2059</span>  <span class="token number">0</span>  <span class="token number">1</span> <span class="token number">97</span>  <span class="token number">2</span>  <span class="token number">0</span>
 <span class="token number">0</span>  <span class="token number">1</span>      <span class="token number">0</span>  <span class="token number">14816</span>    <span class="token number">100</span>    <span class="token number">791</span>    <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>  <span class="token number">1756</span>  <span class="token number">645</span> <span class="token number">1909</span>  <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">93</span>  <span class="token number">6</span>  <span class="token number">0</span>
root@vm-ubuntu:~<span class="token comment"># iostat -xz 1</span>
 avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           <span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">0.50</span>   <span class="token number">13.35</span>    <span class="token number">0.00</span>   <span class="token number">86.15</span>
Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
sda              <span class="token number">0.00</span>  <span class="token number">376.00</span>      <span class="token number">0.00</span>   <span class="token number">4032.00</span>     <span class="token number">0.00</span>   <span class="token number">124.00</span>   <span class="token number">0.00</span>  <span class="token number">24.80</span>    <span class="token number">0.00</span>    <span class="token number">2.70</span>   <span class="token number">0.63</span>     <span class="token number">0.00</span>    <span class="token number">10.72</span>   <span class="token number">2.66</span> <span class="token number">100.00</span>
</code></pre></div><h2 id="before-ssh-経由コマンドのレイテンシ計測"><a href="#before-ssh-経由コマンドのレイテンシ計測" class="header-anchor">#</a> Before: ssh 経由コマンドのレイテンシ計測</h2> <p>手元のマシンから、ssh 経由の <code>echo hello</code> にかかる時間を計測してみる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>openjny@local-machine:~$ <span class="token function">time</span> <span class="token function">ssh</span> openjny@<span class="token operator">&lt;</span>lab-machine<span class="token operator">&gt;</span> -i id_rsa <span class="token builtin class-name">echo</span> hello
hello
real    0m1.489s
user    0m0.057s
sys     0m0.002s
</code></pre></div><p>何回か計測してみたけど、たしかに <code>echo hello</code> するだけで 1 ~ 数秒の時間がかかっていることがわかる。速いのか遅いのかよくわからないけど、eBPF を使ってボトルネックの特定と高速化を試みるとしましょう。</p> <h2 id="調査方針"><a href="#調査方針" class="header-anchor">#</a> 調査方針</h2> <p>今回の分析対象は「生存期間の短いプロセスであり、事前に調査対象の PID がわかっていない」というのが最大の特徴。そのため、数秒おきに stats を出すツール (e.g. vmstat) よりも、<strong>イベント ドリブンな</strong>分析ツールが原因究明の鍵を握りそう。まずは、各コンポーネントで次の確認を進めたい。</p> <ul><li>CPU: プロセス/スレッドの誕生と終了、生存期間</li> <li>メモリ: ページキャッシュの開放有無</li> <li>ファイルシステム、I/O: 新たに <code>open</code> された file の有無、ブロックデバイスへの(物理) I/O 発生状況</li> <li>ネットワーク: ESTABLISH に要した時間、パケットドロップ/再送の量、トラフィックの発生状況</li></ul> <p>使えそうな bcc のツールは以下の通り。</p> <ul><li>(cpu) execsnoop, exitsnoop</li> <li>(memory) drsnoop, shmsnoop</li> <li>(filesystem/io) filelife, biosnoop</li> <li>(network) sofdsnoop, tcplife, tcpstates, tcpretrans</li></ul> <h2 id="ログの収集"><a href="#ログの収集" class="header-anchor">#</a> ログの収集</h2> <p>収集には以下の bash script を利用した。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">BCC_TOOLS</span><span class="token operator">=</span><span class="token string">&quot;/home/openjny/bcc/tools&quot;</span>
<span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token string">&quot;timeout 15s python3 -u&quot;</span>
<span class="token comment"># pid</span>
<span class="token function">ps</span> -aux <span class="token operator">|</span> <span class="token function">grep</span> ssh<span class="token punctuation">[</span>d<span class="token punctuation">]</span> <span class="token operator">&gt;</span> pid_sshd.log
<span class="token comment"># cpu</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/execsnoop.py -xTU <span class="token operator">&gt;</span> execsnoop.log <span class="token operator">&amp;</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/exitsnoop.py --utc <span class="token operator">&gt;</span> exitsnoop.log <span class="token operator">&amp;</span>
<span class="token comment"># memory</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/drsnoop.py <span class="token operator">&gt;</span> drsnoop.log <span class="token operator">&amp;</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/shmsnoop.py <span class="token operator">&gt;</span> shmsnoop.log <span class="token operator">&amp;</span>
<span class="token comment"># fs/io</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/filelife.py <span class="token operator">&gt;</span> filelife.log <span class="token operator">&amp;</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/biosnoop.py <span class="token operator">&gt;</span> biosnoop.log <span class="token operator">&amp;</span>
<span class="token comment"># network</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/sofdsnoop.py <span class="token operator">&gt;</span> sofdsnoop.log <span class="token operator">&amp;</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/tcplife.py <span class="token operator">&gt;</span> tcplife.log <span class="token operator">&amp;</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/tcpstates.py <span class="token operator">&gt;</span> tcpstates.log <span class="token operator">&amp;</span>
<span class="token variable">$PREFIX</span> <span class="token variable">$BCC_TOOLS</span>/tcpretrans.py <span class="token operator">&gt;</span> tcpretrans.log <span class="token operator">&amp;</span>
<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> tcpretrans.log <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span> -lt <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">sleep</span> <span class="token number">1</span>
<span class="token keyword">done</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Start...&quot;</span>
<span class="token function">wait</span>
</code></pre></div><p>このスクリプトを作成している間に、bcc tools は既定で出力バッフを使うものが多く、リダイレクト時に正常に出力をパイプできない問題に遭遇。バッファが関係していそうなのはすぐわかったのだが、自分の環境では何故か <code>stdbuf</code> が効かず、python 側のオプションを利用する方法を発見するまでに時間がかかってしまった…。そして、解決方法は issue ページにあったという 😢</p> <p><a href="https://github.com/iovisor/bcc/issues/905" target="_blank" rel="noopener noreferrer">Stream Redirection Disables All Output · Issue #905 · iovisor/bcc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>採取方法は簡単で、採取スクリプトを <code>sudo</code> で実行して &quot;Start...&quot; が表示されてから、<code>ssh</code> 経由のコマンド (遅い! と問題になっているやつ) をローカルから実行するだけ。</p> <h3 id="採取後の整形"><a href="#採取後の整形" class="header-anchor">#</a> 採取後の整形</h3> <p>採取した (イベント ドリブンな) ログはシステム全体を対象として計測されている。このままではログが多すぎるので、対象 <code>ssh</code> コマンドの実行に関係のあるプロセスのログだけを抽出したい。まずは、<code>execsnoop</code> の結果から、今回の事象によって <code>sshd</code> から生成されたすべての (子孫) プロセスをリストアップする。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment"># extract.py</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> queue <span class="token keyword">import</span> Queue
EXECSNOOP_LOG <span class="token operator">=</span> <span class="token string">'./execsnoop.log'</span>
ROOT_PID <span class="token operator">=</span> <span class="token number">1442</span>
<span class="token keyword">def</span> <span class="token function">canonical_columns</span><span class="token punctuation">(</span>cols<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>c <span class="token keyword">for</span> c <span class="token keyword">in</span> cols <span class="token keyword">if</span> <span class="token keyword">not</span> c<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'Unnamed:'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
df_exec <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_fwf<span class="token punctuation">(</span>EXECSNOOP_LOG<span class="token punctuation">)</span>
df_exec <span class="token operator">=</span> df_exec<span class="token punctuation">[</span>canonical_columns<span class="token punctuation">(</span>df_exec<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">get_child_pids</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> root_pid<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>root_pid<span class="token punctuation">)</span>
    child_pids <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pid <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        child_pids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
        childs <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'PPID'</span><span class="token punctuation">]</span> <span class="token operator">==</span> pid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'PID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> childs<span class="token punctuation">:</span>
            q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">return</span> child_pids
pid_list <span class="token operator">=</span> get_child_pids<span class="token punctuation">(</span>df_exec<span class="token punctuation">,</span> ROOT_PID<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> pid_list<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>こいつを使って、フィルターが必要そうなログはフィルタリングをしておく。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">pids</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>python3 extract.py<span class="token variable">)</span></span>
<span class="token function">mkdir</span> filtered
<span class="token function">cat</span> execsnoop.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$4</span> ~ /'</span><span class="token variable">$pids</span><span class="token string">'/) { print } }'</span> <span class="token operator">&gt;</span> filtered/execsnoop.log
<span class="token function">cat</span> exitsnoop.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$3</span> ~ /'</span><span class="token variable">$pids</span><span class="token string">'/) { print } }'</span> <span class="token operator">&gt;</span> filtered/exitsnoop.log
<span class="token function">cat</span> drsnoop.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$2</span> ~ /'</span><span class="token variable">$pids</span><span class="token string">'/) { print } }'</span> <span class="token operator">&gt;</span> filtered/drsnoop.log
<span class="token function">cat</span> shmsnoop.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$1</span> ~ /'</span><span class="token variable">$pids</span><span class="token string">'/) { print } }'</span> <span class="token operator">&gt;</span> filtered/shmsnoop.log
<span class="token function">cat</span> filelife.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$2</span> ~ /'</span><span class="token variable">$pids</span><span class="token string">'/) { print } }'</span> <span class="token operator">&gt;</span> filtered/filelife.log
<span class="token function">cat</span> biosnoop.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$3</span> ~ /'</span><span class="token variable">$pids</span><span class="token string">'/) { print } }'</span> <span class="token operator">&gt;</span> filtered/biosnoop.log
</code></pre></div><h2 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h2> <h3 id="cpu-観点での調査"><a href="#cpu-観点での調査" class="header-anchor">#</a> CPU 観点での調査</h3> <p>と、ここまで来て初めて気づいたが、フィルタリングが完全でないことが発覚。というのも、<code>execsnoop</code> で検知できていないプロセスの複製/実行があることで、<code>sshd</code> の子孫プロセスの列挙が不完全なものになってしまっていた。ただ、それでもいくつか重要なことがわかった。</p> <p>まず、問題のコマンドが実行されたのは 14:28:58 であり、コマンド処理を担当するプロセスの PID は 27805 として生成されたことがわかる。時刻は大事な情報。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> execsnoop.log <span class="token operator">|</span> <span class="token function">grep</span> /usr/sbin/sshd
<span class="token number">14</span>:28:58 <span class="token number">0</span>     sshd             <span class="token number">27805</span>  <span class="token number">1442</span>     <span class="token number">0</span> /usr/sbin/sshd -D -R
</code></pre></div><p>次に、多数の (少なくとも 60 以上の) プロセスが生成されている。そしてここには <code>/etc/update-motd.d/*</code> のプロセスが多く含まれる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> filtered/execsnoop.log <span class="token operator">|</span> <span class="token function">wc</span> -l
<span class="token number">60</span>
$ <span class="token function">cat</span> filtered/execsnoop.log <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'update-motd.d'</span>
<span class="token number">14</span>:28:58 <span class="token number">0</span>     run-parts        <span class="token number">27820</span>  <span class="token number">27819</span>    <span class="token number">0</span> /bin/run-parts --lsbsysinit /etc/update-motd.d
<span class="token number">14</span>:28:58 <span class="token number">0</span>     00-header        <span class="token number">27821</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/00-header
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">10</span>-help-text     <span class="token number">27825</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/10-help-text
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">50</span>-landscape-sy  <span class="token number">27826</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/50-landscape-sysinfo
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">50</span>-motd-news     <span class="token number">27832</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/50-motd-news
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">88</span>-esm-announce  <span class="token number">27837</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/88-esm-announce
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">90</span>-updates-avai  <span class="token number">27838</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/90-updates-available
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">91</span>-contract-ua-  <span class="token number">27840</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/91-contract-ua-esm-status
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">91</span>-release-upgr  <span class="token number">27841</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/91-release-upgrade
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">92</span>-unattended-u  <span class="token number">27849</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/92-unattended-upgrades
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">95</span>-hwe-eol       <span class="token number">27850</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/95-hwe-eol
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">97</span>-overlayroot   <span class="token number">27866</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/97-overlayroot
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">98</span>-fsck-at-rebo  <span class="token number">27870</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/98-fsck-at-reboot
<span class="token number">14</span>:28:58 <span class="token number">0</span>     <span class="token number">98</span>-reboot-requi  <span class="token number">27876</span>  <span class="token number">27820</span>    <span class="token number">0</span> /etc/update-motd.d/98-reboot-required
</code></pre></div><p><code>/etc/update-motd.d</code> は Ubuntu での MOTD (message of the day) 用スクリプトが格納されているパスなので、ssh との関連性は確かに高い。ここでわかった重要な事実は、ssh 経由でコマンドを実行した場合でも、(表示はされないのにも関わらず) MOTD が実行されるということだ。これは無駄な処理だと考えられる。</p> <p>生存期間の観点では特記すべき点は見られなかった。最も生存期間が長いプロセスは以下 3 つで、0.04 秒程度。ただ、それ以外は特に生存期間が長いプロセスはなく、まんべんなく短い実行時間のプロセスが多数発生していたと考えるのが良さそう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> filtered/exitsnoop.log
TIME-UTC     PCOMM            PID    <span class="token environment constant">PPID</span>   TID    AGE<span class="token punctuation">(</span>s<span class="token punctuation">)</span>  EXIT_CODE
<span class="token punctuation">..</span>.
<span class="token number">14</span>:28:58.722 lsb_release      <span class="token number">27843</span>  <span class="token number">27842</span>  <span class="token number">27843</span>  <span class="token number">0.04</span>    <span class="token number">0</span>
<span class="token number">14</span>:28:58.722 <span class="token function">cut</span>              <span class="token number">27844</span>  <span class="token number">27842</span>  <span class="token number">27844</span>  <span class="token number">0.04</span>    <span class="token number">0</span>
<span class="token number">14</span>:28:58.722 <span class="token number">91</span>-release-upgr  <span class="token number">27842</span>  <span class="token number">27841</span>  <span class="token number">27842</span>  <span class="token number">0.04</span>    <span class="token number">0</span>
</code></pre></div><h3 id="メモリ観点の調査"><a href="#メモリ観点の調査" class="header-anchor">#</a> メモリ観点の調査</h3> <p>特に仮想メモリの飽和は観測されていないので、一旦問題ないと見なしてよいと思う。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> drsnoop.log
COMM           PID     LAT<span class="token punctuation">(</span>ms<span class="token punctuation">)</span> PAGES
$ <span class="token function">cat</span> shmsnoop.log
PID    COMM                SYS              RET AR
$ <span class="token function">dmesg</span> -T <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'oom|Out of memory'</span>
</code></pre></div><h3 id="ファイルシステム、i-o-観点の調査"><a href="#ファイルシステム、i-o-観点の調査" class="header-anchor">#</a> ファイルシステム、I/O 観点の調査</h3> <p>まずは VFS で作成され削除された file 一覧を見てみる。<code>systemd</code> でログイン時に生成されるものくらいしかなさそう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> filelife.log
TIME     PID    COMM             AGE<span class="token punctuation">(</span>s<span class="token punctuation">)</span>  FILE
<span class="token number">14</span>:28:58 <span class="token number">27865</span>  <span class="token function">rm</span>               <span class="token number">0.00</span>    tmp.2mxHTbBPCU
<span class="token number">14</span>:28:58 <span class="token number">1</span>      systemd          <span class="token number">0.29</span>    session-1245.scope
<span class="token number">14</span>:28:58 <span class="token number">1352</span>   systemd-logind   <span class="token number">0.00</span>    <span class="token number">1245</span>
<span class="token number">14</span>:28:58 <span class="token number">469</span>    systemd-journal  <span class="token number">0.00</span>    <span class="token number">9</span>:339183
<span class="token number">14</span>:28:58 <span class="token number">469</span>    systemd-journal  <span class="token number">0.29</span>    <span class="token number">9</span>:339144
<span class="token number">14</span>:28:58 <span class="token number">1</span>      systemd          <span class="token number">0.30</span>    user-1001.slice
<span class="token number">14</span>:28:58 <span class="token number">1352</span>   systemd-logind   <span class="token number">0.00</span>    <span class="token number">1001</span>
</code></pre></div><p>物理デバイスへの I/O も存在しない。ファイルの read や write で時間がかかってるのではないと考えられる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> filtered/biosnoop.log
<span class="token comment"># 念の為、目 grep で非対象 PID を除外して調査も実施</span>
$ <span class="token function">cat</span> biosnoop.log <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ if (<span class="token variable">$3</span> !~ /0|385|17836|17841|17829/) { print } }'</span>
<span class="token comment"># 定常的に物理 I/O を発生させている PID を列挙するには以下を実行</span>
<span class="token comment"># tmp=$(mktemp)</span>
<span class="token comment"># timeout 5s biosnoop.py &gt; $tmp</span>
<span class="token comment"># cat $tmp | awk '{print $3}' | sed '1d' | sort | uniq | paste -sd'|'</span>
</code></pre></div><h3 id="ネットワーク観点の調査"><a href="#ネットワーク観点の調査" class="header-anchor">#</a> ネットワーク観点の調査</h3> <p>tcplife で TCP コネクション確立/終了のライフサイクルを見てみる。22 ポートとの通信が一つ存在した。送受信バイト数もそれぞれ 2 KB と少なめ。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> tcplife.log
PID   COMM       LADDR           LPORT RADDR           RPORT TX_KB RX_KB MS
<span class="token number">0</span>     swapper/3  <span class="token number">10.0</span>.0.4        <span class="token number">22</span>    <span class="token operator">&lt;</span>local-ip-addr<span class="token operator">&gt;</span> <span class="token number">4146</span>      <span class="token number">2</span>     <span class="token number">2</span> <span class="token number">659.94</span>
</code></pre></div><p>ここで、生成されているプロセス数がここまで多いと、他にも通信を発生させてるプロセスはあるのでは? という疑問が発生。このログからだけだとなんとも言えないが、何度か <code>tcplife</code> のログをとってると、当該コマンドを実行して発生する TCP コネクションは 1 本だけであることがわかった。安心して、この TCP コネクションについて調査を進めるとする。</p> <p>SYN を送ってから ESTAB になるまでの時間 (3-way handshake latency) は 0.012 秒。全く問題ない。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> tcpstates.log <span class="token operator">|</span> <span class="token function">grep</span> ffff8cf3ab844ec0 
SKADDR           C-PID C-COMM     LADDR           LPORT RADDR           RPORT OLDSTATE    -<span class="token operator">&gt;</span> NEWSTATE
ffff8cf3ab844ec0 <span class="token number">0</span>     swapper/3  <span class="token number">0.0</span>.0.0         <span class="token number">22</span>    <span class="token number">0.0</span>.0.0         <span class="token number">0</span>     LISTEN      -<span class="token operator">&gt;</span> SYN_RECV    <span class="token number">0.000</span>
ffff8cf3ab844ec0 <span class="token number">0</span>     swapper/3  <span class="token number">10.0</span>.0.4        <span class="token number">22</span>    <span class="token number">126.149</span>.198.88  <span class="token number">4146</span>  SYN_RECV    -<span class="token operator">&gt;</span> ESTABLISHED <span class="token number">0.012</span>
ffff8cf3ab844ec0 <span class="token number">27805</span> sshd       <span class="token number">10.0</span>.0.4        <span class="token number">22</span>    <span class="token number">126.149</span>.198.88  <span class="token number">4146</span>  ESTABLISHED -<span class="token operator">&gt;</span> FIN_WAIT1   <span class="token number">613.626</span>
ffff8cf3ab844ec0 <span class="token number">0</span>     swapper/3  <span class="token number">10.0</span>.0.4        <span class="token number">22</span>    <span class="token number">126.149</span>.198.88  <span class="token number">4146</span>  FIN_WAIT1   -<span class="token operator">&gt;</span> CLOSING     <span class="token number">11.181</span>
ffff8cf3ab844ec0 <span class="token number">0</span>     swapper/3  <span class="token number">10.0</span>.0.4        <span class="token number">22</span>    <span class="token number">126.149</span>.198.88  <span class="token number">4146</span>  CLOSING     -<span class="token operator">&gt;</span> CLOSE       <span class="token number">35.128</span>
</code></pre></div><p>再送も存在していないので、ネットワーク観点でボトルネックの兆候は見られない。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> tcpretrans.log
Tracing retransmits <span class="token punctuation">..</span>. Hit Ctrl-C to end
TIME     PID    IP LADDR:LPORT          T<span class="token operator">&gt;</span> RADDR:RPORT          STATE
</code></pre></div><h3 id="一次見解"><a href="#一次見解" class="header-anchor">#</a> 一次見解</h3> <p>当該コマンドは、仮想メモリ、ファイルシステム、I/O、ネットワークの観点ではボトルネックとなる程の処理を観測していない。最も可能性があるのは、大量にプロセスが生成されていることで、特に motd によって無駄なログイン処理が発生していることが示唆された。</p> <h2 id="対応策"><a href="#対応策" class="header-anchor">#</a> 対応策</h2> <p><code>systemd</code> の動作を調べるのは時間がかかりそうだったので、<code>/etc/update-motd.d</code> 自体を削除するという単純な方法で対応をしてみる。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>root@vm-ubuntu:/etc<span class="token comment"># mv /etc/update-motd.d/ /etc/update-motd.d.old</span>
</code></pre></div><h3 id="after-ssh-経由コマンドのレイテンシ計測"><a href="#after-ssh-経由コマンドのレイテンシ計測" class="header-anchor">#</a> After: ssh 経由コマンドのレイテンシ計測</h3> <p>対応後のコマンド実行レイテンシを何度か計測してみた。確かに 1 秒以上時間がかかるようなことはなくなり、改善が見られた。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>openjny@local-machine:~$ <span class="token function">time</span> <span class="token function">ssh</span> openjny@<span class="token operator">&lt;</span>lab-machine<span class="token operator">&gt;</span> -i id_rsa <span class="token builtin class-name">echo</span> hello
hello
real    0m0.598s
user    0m0.034s
sys     0m0.012s
</code></pre></div><p>また、<code>execsnoop</code> で実行されるプロセス数をカウントしてみると、対応前 60 以上あった子孫プロセスが、10 程度に抑えられていることも確認できた。</p> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <p>今回の課題では、非常に生存時間が短く、かつ事前にわかっているのは <code>fork</code> 元のプロセス ID だけ、というアプリケーションのレイテンシを増加させている原因を調査しました。WEB アプリケーションへの GET 要求等、ネットワーク越しの処理はおそらくこのようなシナリオに該当するのだろう。</p> <p>そして、<code>strace</code> や <code>tcpdump</code> 等が使えないセンシティブなサーバー環境でも、コンポーネントごとにワークロード計測ができることを確認できました。十分とは言えないかもしれないけど、実際にレイテンシを削減することのできる対応を考えつくことが出来たので、最低限のところまでは対応できたと思います。</p> <p>ただ、<code>systemd</code> の動作がわかっていればよりプロセス間の関係、生成されたプロセスの意味が解釈しやすかったのだろうと思うと、やはり内部アーキテクチャを知っていることは重要であることを改めて感じた。また、今回は bcc だけで乗り切ったけど、<code>bpftrace</code> でだけ提供されているネットワーク系ツール等も発見したので、今後活用していきたい。</p></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      作成日 : 2021-05-18
    </span> <span class="update-date" data-v-4e23451f>
      更新日 : 2021-05-20
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2021/05/13/bpf-perf-workshop-lab1/" class="post-link" data-v-4e23451f>
      前の投稿 : [bpf-perf-workshop] lab1: レイテンシ調査
    </a> <!----></section></section> <!----></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" data-v-9d847660><img src="https://pbs.twimg.com/profile_images/845174054273236993/aYDqys_v_400x400.jpg" alt="OpenJNY" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      OpenJNY
    </section> <section class="info-desc" data-v-9d847660>Laugh and grow fat :D</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Tokyo, Japan" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Tokyo, Japan</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Tokyo, Japan
        </span></span></section> <!----> <section data-v-9d847660><a href="mailto:openjny@gmail.com" title="openjny@gmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>openjny@gmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          openjny@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://twitter.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="Twitter: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Twitter: openjny</title><use xlink:href="#icon-twitter" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://github.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: openjny</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://www.linkedin.com/in/ja-junya-yamaguchi" target="_blank" class="sns-link" data-v-9d847660><span title="LinkedIn: junya-yamaguchi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>LinkedIn: junya-yamaguchi</title><use xlink:href="#icon-linkedin" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://gitlab.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="GitLab: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitLab: openjny</title><use xlink:href="#icon-gitlab" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://bitbucket.org/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="Bitbucket: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Bitbucket: openjny</title><use xlink:href="#icon-bitbucket" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>目次</span> <div class="post-nav-toc"><ul><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#課題">課題</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#ラボ環境のセットアップ">ラボ環境のセットアップ</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#before-ssh-経由コマンドのレイテンシ計測">Before: ssh 経由コマンドのレイテンシ計測</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#調査方針">調査方針</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#ログの収集">ログの収集</a><ul><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#採取後の整形">採取後の整形</a></li></ul></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#分析">分析</a><ul><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#cpu-観点での調査">CPU 観点での調査</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#メモリ観点の調査">メモリ観点の調査</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#ファイルシステム、i-o-観点の調査">ファイルシステム、I/O 観点の調査</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#ネットワーク観点の調査">ネットワーク観点の調査</a></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#一次見解">一次見解</a></li></ul></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#対応策">対応策</a><ul><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#after-ssh-経由コマンドのレイテンシ計測">After: ssh 経由コマンドのレイテンシ計測</a></li></ul></li><li><a href="/posts/2021/05/18/bpf-perf-workshop-lab2/#まとめ">まとめ</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://twitter.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="Twitter: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Twitter: openjny</title><use xlink:href="#icon-twitter" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://github.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: openjny</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://www.linkedin.com/in/ja-junya-yamaguchi" target="_blank" class="sns-link" data-v-1375e54c><span title="LinkedIn: junya-yamaguchi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>LinkedIn: junya-yamaguchi</title><use xlink:href="#icon-linkedin" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://gitlab.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="GitLab: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitLab: openjny</title><use xlink:href="#icon-gitlab" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://bitbucket.org/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="Bitbucket: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Bitbucket: openjny</title><use xlink:href="#icon-bitbucket" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <!----></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.c2a58a0d.js" defer></script><script src="/assets/js/6.da60bd61.js" defer></script><script src="/assets/js/23.4edff57c.js" defer></script>
  </body>
</html>
