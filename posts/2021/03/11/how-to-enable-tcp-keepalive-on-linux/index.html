<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux での TCP KeepAlive 有効化方法 | /etc/openjny</title>
    <meta name="description" content="OpenJNY&#39;s Blog">
    <link rel="icon" type="image/jpg" href="/img/favicon.png">
  <meta name="keywords" content="">
  <meta name="og:title" content="/etc/openjny">
  <meta name="og:description" content="OpenJNY のブログです。技術的な内容から日常的なことまで。">
  <meta name="og:type" content="website">
  <meta name="og:url" content="https://openjny.github.io/">
  <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/mplus1p.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <link rel="preload" href="/assets/css/0.styles.bb124a8c.css" as="style"><link rel="preload" href="/assets/js/app.ad127f09.js" as="script"><link rel="preload" href="/assets/js/6.da60bd61.js" as="script"><link rel="preload" href="/assets/js/21.d3c17663.js" as="script"><link rel="prefetch" href="/assets/js/1.1b1bf802.js"><link rel="prefetch" href="/assets/js/10.3eceda61.js"><link rel="prefetch" href="/assets/js/11.eadad559.js"><link rel="prefetch" href="/assets/js/12.6534dd5b.js"><link rel="prefetch" href="/assets/js/13.842634ec.js"><link rel="prefetch" href="/assets/js/14.16635b1e.js"><link rel="prefetch" href="/assets/js/15.8b241f4f.js"><link rel="prefetch" href="/assets/js/16.a9b2eb54.js"><link rel="prefetch" href="/assets/js/17.9ba6c58f.js"><link rel="prefetch" href="/assets/js/18.7c88f6cd.js"><link rel="prefetch" href="/assets/js/19.0ca7ea79.js"><link rel="prefetch" href="/assets/js/20.6ff41f5a.js"><link rel="prefetch" href="/assets/js/22.cd4f96d8.js"><link rel="prefetch" href="/assets/js/23.e1de2fa2.js"><link rel="prefetch" href="/assets/js/24.64ce043e.js"><link rel="prefetch" href="/assets/js/25.da16e18f.js"><link rel="prefetch" href="/assets/js/26.1809ab3e.js"><link rel="prefetch" href="/assets/js/3.dab4048b.js"><link rel="prefetch" href="/assets/js/4.32c6ed03.js"><link rel="prefetch" href="/assets/js/5.e4585db8.js"><link rel="prefetch" href="/assets/js/7.dfc82521.js"><link rel="prefetch" href="/assets/js/8.6ab3273d.js"><link rel="prefetch" href="/assets/js/9.a25efbed.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bb124a8c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          /etc/openjny
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Posts
          </a><a href="/about-me/" class="navbar-link" data-v-e4145d0a>
            About Me
          </a><a href="https://qiita.com/OpenJNY" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Qiita</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://github.com/OpenJNY/openjny.github.io/tree/vuepress" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Repo</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          Linux での TCP KeepAlive 有効化方法
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      作成日 : 2021-03-11
    </span> <span class="update-date" data-v-4e23451f>
      更新日 : 2021-03-12
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/06/21/velocity-2015-linux-perf-tools-methodologies/" class="post-link" data-v-4e23451f>
      前の投稿 : Velocity 2015, Linux Performance Tools, Brendan Gregg: 方法論
    </a> <a href="/posts/2021/05/13/bpf-perf-workshop-lab1/" class="post-link" data-v-4e23451f>
      次の投稿 : [bpf-perf-workshop] lab1: レイテンシ調査
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><p>Linux の TCP KeepAlive について調べたので、その備忘録です。</p> <p></p><div class="table-of-contents"><ul><li><a href="#tl-dr">TL;DR</a></li><li><a href="#tcp-keepalive-とはなにか">TCP KeepAlive とはなにか</a></li><li><a href="#どうすれば-tcp-keepalive-を有効化できるのか">どうすれば TCP KeepAlive を有効化できるのか</a><ul><li><a href="#socket-とシステムコール">socket とシステムコール</a></li><li><a href="#ss-による-tcp-keepalive-判定">ss による TCP KeepAlive 判定</a></li><li><a href="#strace-による-tcp-keepalive-判定">strace による TCP KeepAlive 判定</a></li></ul></li><li><a href="#os-の仕組みでなんとかならない？">OS の仕組みでなんとかならない？</a><ul><li><a href="#テストプログラム">テストプログラム</a></li><li><a href="#libkeepalive-ありのテストプログラム">libkeepalive ありのテストプログラム</a></li></ul></li><li><a href="#まとめ">まとめ</a></li><li><a href="#参考">参考</a></li></ul></div><p></p> <h2 id="tl-dr"><a href="#tl-dr" class="header-anchor">#</a> TL;DR</h2> <p>Linux は TCP KeepAlive に対応していますが、普通に <code>socket</code> を開くだけだと有効化されません。既定では無効の状態です。アプリケーションが <code>setsockopt</code> システムコールを (第 3 引数 = 1 で) 呼び出して、初めて TCP KeepAlive が有効化されます (ちなみに既定で TCP KeepAlive が無効なのは、Windows でも同様です)。</p> <p>アプリケーションで TCP KeepAlive を有効化するには、2 つの方法がとれます。</p> <ul><li>アプリケーションで <code>setsockopt</code> を実装する。ただし、ソースコードの編集やコンパイル/ビルドが出来る必要があります。</li> <li><code>LD_PRELOAD=libkeepalive.so</code> を環境変数に宣言してからアプリケーションを実行する。ソースコードに手を加えなくて良いのが利点である一方、<code>libkeepalive.so</code> をシステムに導入する必要があるのと、アプリ上の任意の TCP コネクションで TCP KeepAlive が効いてしまうのが欠点。</li></ul> <p>こんな記事を読まなくても、必要なことは <a href="https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/" target="_blank" rel="noopener noreferrer">TCP Keepalive HOWTO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> に全部書いてあります。</p> <h2 id="tcp-keepalive-とはなにか"><a href="#tcp-keepalive-とはなにか" class="header-anchor">#</a> TCP KeepAlive とはなにか</h2> <p>TCP KeepAlive とは、TCP コネクションがアクティブな状態なのか (対向側やその間のネットワークが死んでないか) を検知する為の正常性監視の仕組みです。TCP のレイヤーで実装されているので、基本的にカーネルで制御する義務があります。HTTP KeepAlive とは全くの別物であることに注意しましょう。</p> <p>主たる目的は正常性監視ですが、定期的にパケットを送信する仕組みとして TCP KeepAlive が使われることもあります。ネットワーク データパス上に存在する L4 のネットワーク アプライアンス機器には、しばしばタイムアウトが実装されています。このような機器ではフローテーブル等で通信の状態を保持しておかなければならず、タイムアウトがなければリソース枯渇を招く為です。</p> <p>例えば、30 分間ずっと無通信状態の TCP コネクションがあれば、それ以降のパケットはフォワーディングしないアプライアンスがあったとします。ここに、TCP KeepAlive を導入する動機があります。TCP KeepAlive で 10 分毎に死活監視を行えば、長時間 TCP コネクションが非活性になるのを予防できます。</p> <p>まとめると、TCP KeepAlive の目的は大まかに 2 つです。これらの目的を達成するために、TCP KeepAlive はコネクション単位で有効/無効が設定できるようになっています。</p> <ul><li>対向の正常性を監視すること</li> <li>非活性なネットワークを活性化させて、コネクション切断を防ぐこと</li></ul> <h2 id="どうすれば-tcp-keepalive-を有効化できるのか"><a href="#どうすれば-tcp-keepalive-を有効化できるのか" class="header-anchor">#</a> どうすれば TCP KeepAlive を有効化できるのか</h2> <p>結論から言えば、Linux で TCP KeepAlive を有効化するには <code>setsockopt</code> システムコールを使う必要があります。以下のようなシステムコールが <code>strace</code> で確認できれば、その TCP コネクションで TCP KeepAlive が有効になります (そうでない限り無効です)。</p> <div class="language- extra-class"><pre class="language-text"><code>setsockopt(&lt;sockfd&gt;, SOL_SOCKET, SO_KEEPALIVE, [1], 4)
</code></pre></div><p>※ 第 3 引数が <code>[0]</code> の場合、明示的な無効化を意味します。</p> <h3 id="socket-とシステムコール"><a href="#socket-とシステムコール" class="header-anchor">#</a> socket とシステムコール</h3> <p>そもそもの話として、Linux や Windows 等の標準的な OS では、TCP コネクションを活用したいアプリケーションは socket と呼ばれる特殊なファイルを開きます。例えば、Python3 で (socket を開いて) サーバーに接続するクライアントを作る時は、以下のようなコードを書くでしょう。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> socket
<span class="token keyword">import</span> time
<span class="token keyword">with</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'8.8.8.8'</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre></div><p>このプログラムを動かしてみると、<code>socket.sendall</code> や <code>socket.recv</code> がないので何もクライアントから送受信することは無い (e.g. HTTP のプロトコルに則っていない) のですが、TCP の 3way handshake やクローズの処理は正常に行えていることが確認できます。これだけで TCP コネクションの確立はできてしまうんですね。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> tcpdump <span class="token function">host</span> <span class="token number">8.8</span>.8.8 port <span class="token number">53</span> -ni any
tcpdump: verbose output suppressed, use -v or -vv <span class="token keyword">for</span> full protocol decode
listening on any, link-type LINUX_SLL <span class="token punctuation">(</span>Linux cooked<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes
<span class="token number">16</span>:12:47.319493 IP <span class="token number">10.3</span>.0.5.50528 <span class="token operator">&gt;</span> <span class="token number">8.8</span>.8.8.53: Flags <span class="token punctuation">[</span>S<span class="token punctuation">]</span>, <span class="token function">seq</span> <span class="token number">464911782</span>, win <span class="token number">64240</span>, options <span class="token punctuation">[</span>mss <span class="token number">1460</span>,sackOK,TS val <span class="token number">3113655258</span> ecr <span class="token number">0</span>,nop,wscale <span class="token number">7</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">16</span>:12:47.321744 IP <span class="token number">8.8</span>.8.8.53 <span class="token operator">&gt;</span> <span class="token number">10.3</span>.0.5.50528: Flags <span class="token punctuation">[</span>S.<span class="token punctuation">]</span>, <span class="token function">seq</span> <span class="token number">2773628164</span>, ack <span class="token number">464911783</span>, win <span class="token number">65535</span>,
options <span class="token punctuation">[</span>mss <span class="token number">1430</span>,sackOK,TS val <span class="token number">1138427843</span> ecr <span class="token number">3113655258</span>,nop,wscale <span class="token number">8</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">16</span>:12:47.321781 IP <span class="token number">10.3</span>.0.5.50528 <span class="token operator">&gt;</span> <span class="token number">8.8</span>.8.8.53: Flags <span class="token punctuation">[</span>.<span class="token punctuation">]</span>, ack <span class="token number">1</span>, win <span class="token number">502</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">3113655261</span> ecr <span class="token number">1138427843</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">16</span>:12:47.321963 IP <span class="token number">10.3</span>.0.5.50528 <span class="token operator">&gt;</span> <span class="token number">8.8</span>.8.8.53: Flags <span class="token punctuation">[</span>F.<span class="token punctuation">]</span>, <span class="token function">seq</span> <span class="token number">1</span>, ack <span class="token number">1</span>, win <span class="token number">502</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">3113655261</span> ecr <span class="token number">1138427843</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">16</span>:12:47.323556 IP <span class="token number">8.8</span>.8.8.53 <span class="token operator">&gt;</span> <span class="token number">10.3</span>.0.5.50528: Flags <span class="token punctuation">[</span>F.<span class="token punctuation">]</span>, <span class="token function">seq</span> <span class="token number">1</span>, ack <span class="token number">2</span>, win <span class="token number">256</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">1138427846</span> ecr <span class="token number">3113655261</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">16</span>:12:47.323571 IP <span class="token number">10.3</span>.0.5.50528 <span class="token operator">&gt;</span> <span class="token number">8.8</span>.8.8.53: Flags <span class="token punctuation">[</span>.<span class="token punctuation">]</span>, ack <span class="token number">2</span>, win <span class="token number">502</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">3113655262</span> ecr <span class="token number">1138427846</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
</code></pre></div><p>アプリの実装を紐解く上では、どのようなシステムコールを発行しているか、という点も抑えておきましょう。なぜなら、システムコールはアプリケーションからの要求をカーネルが受け取る唯一の方法であり、後に見るように、<strong>システムコール次第で TCP KeepAlive の有効/無効が決定される</strong> 為です。TCP を管理するのは Kernel のネットワーク スタックなので、TCP KeepAlive に関する調節命令をアプリケーションからカーネルに出さないといけないのも納得ですね。</p> <p>プログラムが発行するシステムコールを調べるには <code>strace</code> を使います。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">strace</span> -ff -e <span class="token assign-left variable">trace</span><span class="token operator">=</span>network python3 client.py <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
socket<span class="token punctuation">(</span>AF_INET, SOCK_STREAM<span class="token operator">|</span>SOCK_CLOEXEC, IPPROTO_IP<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
connect<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET, <span class="token assign-left variable">sin_port</span><span class="token operator">=</span>htons<span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span>, <span class="token assign-left variable">sin_addr</span><span class="token operator">=</span>inet_addr<span class="token punctuation">(</span><span class="token string">&quot;8.8.8.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>, <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
+++ exited with <span class="token number">0</span> +++
</code></pre></div><p>さて、これらのシステムコールによって確立された TCP コネクションは、TCP KeepAlive が有効化されているのでしょうか？</p> <p>初見で判定するのはなかなか難しいところなので、いくつかの既知の知識を使って読み解いて行きましょう。これから使うのは、以下の 2 つのツールです。</p> <ul><li><code>ss</code>: ソケットに関する統計量を取得する観測ツール。<code>-o (--options)</code> を指定すると、TCP KeepAlive の有無やそのタイマーを表示してくれる。</li> <li><code>curl</code>: 様々なプロトコルに対応したクライアント。<code>--no-keepalive</code> を指定すると TCP KeepAlive を無効化、デフォルトのままだと TCP KeepAlive を有効化する。</li></ul> <h3 id="ss-による-tcp-keepalive-判定"><a href="#ss-による-tcp-keepalive-判定" class="header-anchor">#</a> ss による TCP KeepAlive 判定</h3> <p>試しに先程の Python プログラムと、(TCP KeepAlive を有効化した) curl の結果を見比べてみましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ python3 client.py
$ ss -tanoe <span class="token string">'dst 8.8.8.8'</span>
State   Recv-Q   Send-Q   Local Address:Port    Peer Address:Port
ESTAB   <span class="token number">0</span>        <span class="token number">0</span>             <span class="token number">10.3</span>.0.5:52686        <span class="token number">8.8</span>.8.8:53  
users:<span class="token variable"><span class="token punctuation">((</span>&quot;python3&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">29357</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">))</span></span> uid:1000 ino:305411 sk:196 <span class="token operator">&lt;</span>-<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://8.8.8.8:53 <span class="token comment"># --no-keepalive を指定していない (TCP KeepAlive 有効化)</span>
$ ss -tanoe <span class="token string">'dst 8.8.8.8'</span>
State   Recv-Q   Send-Q   Local Address:Port    Peer Address:Port
ESTAB   <span class="token number">0</span>        <span class="token number">0</span>             <span class="token number">10.3</span>.0.5:53326        <span class="token number">8.8</span>.8.8:53   <span class="token punctuation">\</span>
users:<span class="token variable"><span class="token punctuation">((</span>&quot;curl&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">30213</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">))</span></span> timer:<span class="token punctuation">(</span>keepalive,1min,0<span class="token punctuation">)</span> uid:1000 ino:311003 sk:19a <span class="token operator">&lt;</span>-<span class="token operator">&gt;</span>
</code></pre></div><p><code>curl</code> の方には、timer フィールドがあるのがわかりますね。詳細は <code>ss(8)</code> の man に載っていますが、実際、timer フィールドの有無で TCP KeepAlive の有効/無効を判定することが出来ます。具体的には、ESTABLISHED な TCP コネクションを <code>ss -o</code> で確認した時：</p> <ul><li><code>timer:(keepalive, ...)</code> が存在する場合、TCP KeepAlive は有効です。</li> <li><code>timer:(keepalive, ...)</code> が存在しない場合、TCP KeepAlive は無効です。</li></ul> <p>ちなみに、timer のセマンティクスは以下の通りです。</p> <div class="language- extra-class"><pre class="language-text"><code>timer:(&lt;timer_name&gt;,&lt;expire_time&gt;,&lt;retrans&gt;)
&lt;timer_name&gt;
        the name of the timer, there are five kind of timer names:
        on : means one of these timers: TCP retrans timer, TCP early retrans timer and tail loss probe timer
        keepalive: tcp keep alive timer
        timewait: timewait stage timer
        persist: zero window probe timer
        unknown: none of the above timers
&lt;expire_time&gt;
        how long time the timer will expire
&lt;retrans&gt;
        how many times the retransmission occurred
</code></pre></div><ul><li>ref: <a href="https://man7.org/linux/man-pages/man8/ss.8.html" target="_blank" rel="noopener noreferrer">man 8 ss<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="strace-による-tcp-keepalive-判定"><a href="#strace-による-tcp-keepalive-判定" class="header-anchor">#</a> strace による TCP KeepAlive 判定</h3> <p>最初の Python プログラムでは TCP KeepAlive が有効になっていなかったことがわかりました。ここまでくればあともう一息。最後に <code>curl</code> が発行しているシステムコールを見るだけです。具体的には、TCP KeepAlive オプションによるシステムコールの差分を見てみます。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>$ strace -e trace=network -o on.log curl http://8.8.8.8:53
$ strace -e trace=network -o off.log curl http://8.8.8.8:53 --no-keepalive
$ diff on.log off.log
<span class="token deleted-arrow deleted">&lt; setsockopt(3, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0
&lt; setsockopt(3, SOL_TCP, TCP_KEEPIDLE, [60], 4) = 0
&lt; setsockopt(3, SOL_TCP, TCP_KEEPINTVL, [60], 4) = 0
&lt; getsockname(3, {sa_family=AF_INET, sin_port=htons(57040), sin_addr=inet_addr(&quot;10.3.0.5&quot;)}, [128-&gt;16]) = 0
</span><span class="token inserted-arrow inserted">&gt; getsockname(3, {sa_family=AF_INET, sin_port=htons(57012), sin_addr=inet_addr(&quot;10.3.0.5&quot;)}, [128-&gt;16]) = 0
</span></code></pre></div><p>TCP KeepAlive が有効化されている時は <code>setsockopt</code> で指定されていますね。strace で見た時に <code>setsockopt(&lt;sockfd&gt;, SOL_SOCKET, SO_KEEPALIVE, [1], 4)</code>  が存在すれば有効になってそうな匂いを感じます (<code>TCP_KEEPIDLE</code> とか <code>TCP_KEEPINTVL</code> はデフォルト インターバル値の上書きと予想できます)。</p> <p>Linux 関連のドキュメントを検索したところ、下記のセクション 4.2 にまさに探していた情報が載っていました。嗅覚は当たっていました 👏</p> <blockquote><p>All you need to enable keepalive for a specific socket is to set the specific socket option on the socket itself. The prototype of the function is as follows:</p> <p>int setsockopt(int s, int level, int optname,
const void *optval, socklen_t optlen)</p> <p>The first parameter is the socket, previously created with the socket(2); the second one must be SOL_SOCKET, and the third must be SO_KEEPALIVE . The fourth parameter must be a boolean integer value, indicating that we want to enable the option, while the last is the size of the value passed before.</p></blockquote> <p><a href="https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/" target="_blank" rel="noopener noreferrer">TCP Keepalive HOWTO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>第 3 引数に <code>1</code> (の値を格納した 4 byte のメモリスペースへのポインタ) を指定すれば、第 1 引数に指定した <code>sockfd</code> の TCP KeepAlive が有効になるそうです。</p> <h2 id="os-の仕組みでなんとかならない？"><a href="#os-の仕組みでなんとかならない？" class="header-anchor">#</a> OS の仕組みでなんとかならない？</h2> <p><code>setsockopt</code> でごにょごにょすれば TCP KeepAlive を有効化できるのはわかった。でもそれだとソースコードをいじらないといけなくて、めんどくさい。後は自分がアプリケーションのソースコードを保有してる/改修できるとは限らないので、なんとか OS の仕組みで TCP KeepAlive 有効化できないの？と思いますよね。</p> <p>しっかりありました。<code>LD_PRELOAD</code> というものだそうです。</p> <p><code>LD_PRELOAD</code> は Linux の特別な環境変数で、動的ライブラリ/共有ライブラリへのパスを値として設定すると、任意の動的ライブラリよりもそのライブラリが優先的にリンクされてプログラムが実行されます。この機能に着目したのが、<code>libkeepalive.so</code> です。これは、<code>socket</code> を開いた時に一緒に TCP KeepAlive も有効化するように、TCP KeepAlive にチューニングされたソケット機能を提供するライブラリです。</p> <p><a href="http://libkeepalive.sourceforge.net/" target="_blank" rel="noopener noreferrer">http://libkeepalive.sourceforge.net/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>実際に使ってみるとその効果がわかるので、テストプログラムを動かしてみることをおすすめします。</p> <h3 id="テストプログラム"><a href="#テストプログラム" class="header-anchor">#</a> テストプログラム</h3> <p><a href="https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/" target="_blank" rel="noopener noreferrer">TCP Keepalive HOWTO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> のセクション 4.3 にあるプログラム <code>test</code> を動かしてみます。</p> <ul><li><code>test</code> は、単に socket をひとつ新たにオープンします。</li> <li>その直後、socket の TCP KeepAlive 設定 (SO_KEEPALIVE) 値を出力します。通常であれば無効化 (<code>0</code>) となっているはずの値ですね。</li> <li>その後、<code>setsockopt</code> を使って、明示的に TCP KeepAlive を有効化します。</li> <li>再度 SO_KEEPALIVE の現在値を出力します。最後には有効 (<code>1</code>) となっているはずです。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">&gt;</span>test.c
<span class="token comment">#include &lt;stdio.h&gt;</span>
<span class="token comment">#include &lt;stdlib.h&gt;</span>
<span class="token comment">#include &lt;unistd.h&gt;</span>
<span class="token comment">#include &lt;sys/types.h&gt;</span>
<span class="token comment">#include &lt;sys/socket.h&gt;</span>
<span class="token comment">#include &lt;netinet/in.h&gt;</span>
int <span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   int s<span class="token punctuation">;</span>
   int optval<span class="token punctuation">;</span>
   socklen_t optlen <span class="token operator">=</span> sizeof<span class="token punctuation">(</span>optval<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token variable"><span class="token punctuation">((</span>s <span class="token operator">=</span> socket<span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">))</span></span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      perror<span class="token punctuation">(</span><span class="token string">&quot;socket()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      exit<span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   if<span class="token punctuation">(</span>getsockopt<span class="token punctuation">(</span>s, SOL_SOCKET, SO_KEEPALIVE, <span class="token operator">&amp;</span>optval, <span class="token operator">&amp;</span>optlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      perror<span class="token punctuation">(</span><span class="token string">&quot;getsockopt()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      close<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      exit<span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   printf<span class="token punctuation">(</span><span class="token string">&quot;SO_KEEPALIVE is %s<span class="token entity" title="\n">\n</span>&quot;</span>, <span class="token punctuation">(</span>optval ? <span class="token string">&quot;ON&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;OFF&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
   optval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   optlen <span class="token operator">=</span> sizeof<span class="token punctuation">(</span>optval<span class="token punctuation">)</span><span class="token punctuation">;</span>
   if<span class="token punctuation">(</span>setsockopt<span class="token punctuation">(</span>s, SOL_SOCKET, SO_KEEPALIVE, <span class="token operator">&amp;</span>optval, optlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      perror<span class="token punctuation">(</span><span class="token string">&quot;setsockopt()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      close<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      exit<span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   printf<span class="token punctuation">(</span><span class="token string">&quot;SO_KEEPALIVE set on socket<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   if<span class="token punctuation">(</span>getsockopt<span class="token punctuation">(</span>s, SOL_SOCKET, SO_KEEPALIVE, <span class="token operator">&amp;</span>optval, <span class="token operator">&amp;</span>optlen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      perror<span class="token punctuation">(</span><span class="token string">&quot;getsockopt()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      close<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      exit<span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   printf<span class="token punctuation">(</span><span class="token string">&quot;SO_KEEPALIVE is %s<span class="token entity" title="\n">\n</span>&quot;</span>, <span class="token punctuation">(</span>optval ? <span class="token string">&quot;ON&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;OFF&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
   close<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
   exit<span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
EOF
$ gcc -o <span class="token builtin class-name">test</span> test.c
$ ./test
SO_KEEPALIVE is OFF
SO_KEEPALIVE <span class="token builtin class-name">set</span> on socket
SO_KEEPALIVE is ON
$ <span class="token function">strace</span> -e <span class="token assign-left variable">trace</span><span class="token operator">=</span>network ./test
socket<span class="token punctuation">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
getsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
SO_KEEPALIVE is OFF
setsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
SO_KEEPALIVE <span class="token builtin class-name">set</span> on socket
getsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
SO_KEEPALIVE is ON
</code></pre></div><p>何の変哲もない期待通りの動作です。繰り返しになりますが、<code>setsockopt</code> で <code>SO_KEEPALIVE</code> を 1 にセットしない限り、デフォルトでは TCP KeepAlive は無効のままです。</p> <h3 id="libkeepalive-ありのテストプログラム"><a href="#libkeepalive-ありのテストプログラム" class="header-anchor">#</a> libkeepalive ありのテストプログラム</h3> <p>続いて <code>libkeepalive.so</code> をかましてみるとどうなるか。以下の通り、デフォルトの動作が変化します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">wget</span>  https://excellmedia.dl.sourceforge.net/project/libkeepalive/libkeepalive/0.3/libkeepalive-0.3.tar.gz
$ <span class="token function">tar</span> -xzvf libkeepalive-0.3.tar.gz
$ <span class="token builtin class-name">cd</span> libkeepalive-0.3
$ <span class="token function">make</span>
$ <span class="token function">sudo</span> <span class="token function">cp</span> libkeepalive.so /usr/lib/
$ <span class="token assign-left variable">LD_PRELOAD</span><span class="token operator">=</span>/usr/lib/libkeepalive.so ./test
SO_KEEPALIVE is ON
SO_KEEPALIVE <span class="token builtin class-name">set</span> on socket
SO_KEEPALIVE is ON
$ $ <span class="token assign-left variable">LD_PRELOAD</span><span class="token operator">=</span>/usr/lib/libkeepalive.so <span class="token function">strace</span> -e <span class="token assign-left variable">trace</span><span class="token operator">=</span>network ./test
socket<span class="token punctuation">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
setsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
getsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
SO_KEEPALIVE is ON
setsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
SO_KEEPALIVE <span class="token builtin class-name">set</span> on socket
getsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_KEEPALIVE, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
SO_KEEPALIVE is ON
+++ exited with <span class="token number">0</span> +++
</code></pre></div><p>先程と違い <code>setsockopt(3, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0</code> が (知らない間に) 挿入されていることがわかります。これが共有ライブラリの差し替えによる効果です。ただし、<code>LD_PRELOAD</code> を使うと、アプリ上で開いた全ての socket で TCP KeepAlive が有効化されるので、その点は配慮しなくてはなりません。</p> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <p>TCP コネクション確立時に発行されるシステムコールが、プログラムの作り方やコマンドの指定方法によって異なることを確認し、<code>setsockopt</code>  が TCP KeepAlive に関わる重要なシステムコールであることを見てきました。最終的に <code>setsockopt</code> をカーネルに送らなければならないことに変わりはありませんが、共有ライブラリの差し替えテクニック (<code>libkeepalive</code>) によって、任意のプログラムで強制的に TCP KeepAlive を有効化する技術についても紹介しました。<code>nc</code> のような TCP KeepAlive に対応していないアプリをカスタマイズするのに使えそうです。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/" target="_blank" rel="noopener noreferrer">TCP Keepalive HOWTO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.microsoft.com/ja-jp/windows-hardware/drivers/network/so-keepalive" target="_blank" rel="noopener noreferrer">SO_KEEPALIVE - Windows drivers | Microsoft Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/@rajivsharma.2205/enable-tcp-keepalive-on-redis-cluster-bus-153128e412fa" target="_blank" rel="noopener noreferrer">Enable TCP keepalive on Redis cluster bus (gossip inside cluster) | by Rajivsharma | Medium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kazuhira-r.hatenablog.com/entry/2020/02/27/002840" target="_blank" rel="noopener noreferrer">LinuxのTCP Keep-Aliveを確認する - CLOVER🍀<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://man7.org/linux/man-pages/man8/ss.8.html" target="_blank" rel="noopener noreferrer">ss(8) - Linux manual page<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://tech.tier4.jp/entry/2021/03/10/160000" target="_blank" rel="noopener noreferrer">eBPFやLD_PRELOADを利用した共有ライブラリの関数フック - Tier IV Tech Blog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://quickhack.net/nom/blog/2018-01-19-enable-tcp-keepalive-of-macos-and-linux-in-ruby.html" target="_blank" rel="noopener noreferrer">Enable TCP keepalive of macOS and Linux in Ruby<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://qiita.com/developer-kikikaikai/items/f6f87b2d1d7c3e14fb52" target="_blank" rel="noopener noreferrer">既存プログラムの関数を書き換える、強力で危険なLinux環境変数LD_PRELOAD - Qiita<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      作成日 : 2021-03-11
    </span> <span class="update-date" data-v-4e23451f>
      更新日 : 2021-03-12
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/06/21/velocity-2015-linux-perf-tools-methodologies/" class="post-link" data-v-4e23451f>
      前の投稿 : Velocity 2015, Linux Performance Tools, Brendan Gregg: 方法論
    </a> <a href="/posts/2021/05/13/bpf-perf-workshop-lab1/" class="post-link" data-v-4e23451f>
      次の投稿 : [bpf-perf-workshop] lab1: レイテンシ調査
    </a></section></section> <!----></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" data-v-9d847660><img src="https://pbs.twimg.com/profile_images/1347343742362034176/JolObIwJ_400x400.jpg" alt="OpenJNY" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      OpenJNY
    </section> <section class="info-desc" data-v-9d847660>Laugh and grow fat :D</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Tokyo, Japan" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Tokyo, Japan</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Tokyo, Japan
        </span></span></section> <!----> <section data-v-9d847660><a href="mailto:openjny@gmail.com" title="openjny@gmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>openjny@gmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          openjny@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://twitter.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="Twitter: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Twitter: openjny</title><use xlink:href="#icon-twitter" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://github.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: openjny</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://www.linkedin.com/in/ja-junya-yamaguchi" target="_blank" class="sns-link" data-v-9d847660><span title="LinkedIn: junya-yamaguchi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>LinkedIn: junya-yamaguchi</title><use xlink:href="#icon-linkedin" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://gitlab.com/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="GitLab: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitLab: openjny</title><use xlink:href="#icon-gitlab" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://bitbucket.org/openjny" target="_blank" class="sns-link" data-v-9d847660><span title="Bitbucket: openjny" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Bitbucket: openjny</title><use xlink:href="#icon-bitbucket" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>目次</span> <div class="post-nav-toc"><ul><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#tl-dr">TL;DR</a></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#tcp-keepalive-とはなにか">TCP KeepAlive とはなにか</a></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#どうすれば-tcp-keepalive-を有効化できるのか">どうすれば TCP KeepAlive を有効化できるのか</a><ul><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#socket-とシステムコール">socket とシステムコール</a></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#ss-による-tcp-keepalive-判定">ss による TCP KeepAlive 判定</a></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#strace-による-tcp-keepalive-判定">strace による TCP KeepAlive 判定</a></li></ul></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#os-の仕組みでなんとかならない？">OS の仕組みでなんとかならない？</a><ul><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#テストプログラム">テストプログラム</a></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#libkeepalive-ありのテストプログラム">libkeepalive ありのテストプログラム</a></li></ul></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#まとめ">まとめ</a></li><li><a href="/posts/2021/03/11/how-to-enable-tcp-keepalive-on-linux/#参考">参考</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://twitter.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="Twitter: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Twitter: openjny</title><use xlink:href="#icon-twitter" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://github.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: openjny</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://www.linkedin.com/in/ja-junya-yamaguchi" target="_blank" class="sns-link" data-v-1375e54c><span title="LinkedIn: junya-yamaguchi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>LinkedIn: junya-yamaguchi</title><use xlink:href="#icon-linkedin" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://gitlab.com/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="GitLab: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitLab: openjny</title><use xlink:href="#icon-gitlab" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://bitbucket.org/openjny" target="_blank" class="sns-link" data-v-1375e54c><span title="Bitbucket: openjny" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Bitbucket: openjny</title><use xlink:href="#icon-bitbucket" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <!----></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.ad127f09.js" defer></script><script src="/assets/js/6.da60bd61.js" defer></script><script src="/assets/js/21.d3c17663.js" defer></script>
  </body>
</html>
