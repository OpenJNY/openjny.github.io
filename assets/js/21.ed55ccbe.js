(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{215:function(t,s,a){"use strict";a.r(s);var e=a(1),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("Linux ã® TCP KeepAlive ã«ã¤ã„ã¦èª¿ã¹ãŸã®ã§ã€ãã®å‚™å¿˜éŒ²ã§ã™ã€‚")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#tl-dr"}},[t._v("TL;DR")])]),a("li",[a("a",{attrs:{href:"#tcp-keepalive-ã¨ã¯ãªã«ã‹"}},[t._v("TCP KeepAlive ã¨ã¯ãªã«ã‹")])]),a("li",[a("a",{attrs:{href:"#ã©ã†ã™ã‚Œã°-tcp-keepalive-ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã®ã‹"}},[t._v("ã©ã†ã™ã‚Œã° TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã®ã‹")]),a("ul",[a("li",[a("a",{attrs:{href:"#socket-ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«"}},[t._v("socket ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«")])]),a("li",[a("a",{attrs:{href:"#ss-ã«ã‚ˆã‚‹-tcp-keepalive-åˆ¤å®š"}},[t._v("ss ã«ã‚ˆã‚‹ TCP KeepAlive åˆ¤å®š")])]),a("li",[a("a",{attrs:{href:"#strace-ã«ã‚ˆã‚‹-tcp-keepalive-åˆ¤å®š"}},[t._v("strace ã«ã‚ˆã‚‹ TCP KeepAlive åˆ¤å®š")])])])]),a("li",[a("a",{attrs:{href:"#os-ã®ä»•çµ„ã¿ã§ãªã‚“ã¨ã‹ãªã‚‰ãªã„ï¼Ÿ"}},[t._v("OS ã®ä»•çµ„ã¿ã§ãªã‚“ã¨ã‹ãªã‚‰ãªã„ï¼Ÿ")]),a("ul",[a("li",[a("a",{attrs:{href:"#ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ "}},[t._v("ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ")])]),a("li",[a("a",{attrs:{href:"#libkeepalive-ã‚ã‚Šã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ "}},[t._v("libkeepalive ã‚ã‚Šã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ")])])])]),a("li",[a("a",{attrs:{href:"#ã¾ã¨ã‚"}},[t._v("ã¾ã¨ã‚")])]),a("li",[a("a",{attrs:{href:"#å‚è€ƒ"}},[t._v("å‚è€ƒ")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"tl-dr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tl-dr"}},[t._v("#")]),t._v(" TL;DR")]),t._v(" "),a("p",[t._v("Linux ã‚„ TCP KeepAlive ã«å¯¾å¿œã—ã¦ã„ã¾ã™ãŒã€æ™®é€šã« "),a("code",[t._v("socket")]),t._v(" ã‚’é–‹ãã ã‘ã ã¨æœ‰åŠ¹åŒ–ã•ã‚Œã¾ã›ã‚“ã€‚æ—¢å®šã§ã¯ç„¡åŠ¹ã®çŠ¶æ…‹ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ "),a("code",[t._v("setsockopt")]),t._v(" ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ (ç¬¬ 3 å¼•æ•° = 1 ã§) å‘¼ã³å‡ºã—ã¦ã€åˆã‚ã¦ TCP KeepAlive ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™ (ã¡ãªã¿ã«æ—¢å®šã§ TCP KeepAlive ãŒç„¡åŠ¹ãªã®ã¯ã€Windows ã§ã‚‚åŒæ§˜ã§ã™)ã€‚")]),t._v(" "),a("p",[t._v("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã«ã¯ã€2 ã¤ã®æ–¹æ³•ãŒã¨ã‚Œã¾ã™ã€‚")]),t._v(" "),a("ul",[a("li",[t._v("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ "),a("code",[t._v("setsockopt")]),t._v(" ã‚’å®Ÿè£…ã™ã‚‹ã€‚ãŸã ã—ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ç·¨é›†ã‚„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«/ãƒ“ãƒ«ãƒ‰ãŒå‡ºæ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")]),t._v(" "),a("li",[a("code",[t._v("LD_PRELOAD=libkeepalive.so")]),t._v(" ã‚’ç’°å¢ƒå¤‰æ•°ã«å®£è¨€ã—ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«æ‰‹ã‚’åŠ ãˆãªãã¦è‰¯ã„ã®ãŒåˆ©ç‚¹ã§ã‚ã‚‹ä¸€æ–¹ã€"),a("code",[t._v("libkeepalive.so")]),t._v(" ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«å°å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¨ã€ã‚¢ãƒ—ãƒªä¸Šã®ä»»æ„ã® TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã§ TCP KeepAlive ãŒåŠ¹ã„ã¦ã—ã¾ã†ã®ãŒæ¬ ç‚¹ã€‚")])]),t._v(" "),a("p",[t._v("ã“ã‚“ãªè¨˜äº‹ã‚’èª­ã¾ãªãã¦ã‚‚ã€å¿…è¦ãªã“ã¨ã¯ "),a("a",{attrs:{href:"https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP Keepalive HOWTO"),a("OutboundLink")],1),t._v(" ã«å…¨éƒ¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚")]),t._v(" "),a("h2",{attrs:{id:"tcp-keepalive-ã¨ã¯ãªã«ã‹"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp-keepalive-ã¨ã¯ãªã«ã‹"}},[t._v("#")]),t._v(" TCP KeepAlive ã¨ã¯ãªã«ã‹")]),t._v(" "),a("p",[t._v("TCP KeepAlive ã¨ã¯ã€TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªçŠ¶æ…‹ãªã®ã‹ (å¯¾å‘å´ã‚„ãã®é–“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒæ­»ã‚“ã§ãªã„ã‹) ã‚’æ¤œçŸ¥ã™ã‚‹ç‚ºã®æ­£å¸¸æ€§ç›£è¦–ã®ä»•çµ„ã¿ã§ã™ã€‚TCP ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€åŸºæœ¬çš„ã«ã‚«ãƒ¼ãƒãƒ«ã§åˆ¶å¾¡ã™ã‚‹ç¾©å‹™ãŒã‚ã‚Šã¾ã™ã€‚HTTP KeepAlive ã¨ã¯å…¨ãã®åˆ¥ç‰©ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚")]),t._v(" "),a("p",[t._v("ä¸»ãŸã‚‹ç›®çš„ã¯æ­£å¸¸æ€§ç›£è¦–ã§ã™ãŒã€å®šæœŸçš„ã«ãƒ‘ã‚±ãƒƒãƒˆã‚’é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã¨ã—ã¦ TCP KeepAlive ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ä¸Šã«å­˜åœ¨ã™ã‚‹ L4 ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¢ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ©Ÿå™¨ã«ã¯ã€ã—ã°ã—ã°ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªæ©Ÿå™¨ã§ã¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç­‰ã§é€šä¿¡ã®çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ãŠã‹ãªã‘ã‚Œã°ãªã‚‰ãšã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒãªã‘ã‚Œã°ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡ã‚’æ‹›ãç‚ºã§ã™ã€‚ä¾‹ãˆã°ã€30 åˆ†é–“ãšã£ã¨ç„¡é€šä¿¡çŠ¶æ…‹ã® TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°ã€ãã‚Œä»¥é™ã®ãƒ‘ã‚±ãƒƒãƒˆã¯ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã“ã«ã€(ä¾‹ãˆã° 10 åˆ†æ¯ã«æ­»æ´»ç›£è¦–ã‚’è¡Œã†ã‚ˆã†ãª) TCP KeepAlive ã‚’å°å…¥ã™ã‚‹å‹•æ©ŸãŒã‚ã‚Šã¾ã™ã€‚")]),t._v(" "),a("p",[t._v("ã¾ã¨ã‚ã‚‹ã¨ã€TCP KeepAlive ã®ç›®çš„ã¯å¤§ã¾ã‹ã« 2 ã¤ã§ã™ã€‚ã“ã‚Œã‚‰ã®ç›®çš„ã‚’é”æˆã™ã‚‹ãŸã‚ã«ã€TCP KeepAlive ã¯ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³å˜ä½ã§æœ‰åŠ¹/ç„¡åŠ¹ãŒè¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚")]),t._v(" "),a("ul",[a("li",[t._v("å¯¾å‘ã®æ­£å¸¸æ€§ã‚’ç›£è¦–ã™ã‚‹ã“ã¨")]),t._v(" "),a("li",[t._v("éæ´»æ€§ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ´»æ€§åŒ–ã•ã›ã¦ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ–­ã‚’é˜²ãã“ã¨")])]),t._v(" "),a("h2",{attrs:{id:"ã©ã†ã™ã‚Œã°-tcp-keepalive-ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã®ã‹"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ã©ã†ã™ã‚Œã°-tcp-keepalive-ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã®ã‹"}},[t._v("#")]),t._v(" ã©ã†ã™ã‚Œã° TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã®ã‹")]),t._v(" "),a("p",[t._v("ç­”ãˆã‹ã‚‰è¨€ãˆã°ã€Linux ã§ TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã«ã¯ "),a("code",[t._v("setsockopt")]),t._v(" ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒ "),a("code",[t._v("strace")]),t._v(" ã§ç¢ºèªã§ãã‚Œã°ã€ãã® TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ TCP KeepAlive ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ (ãã†ã§ãªã„é™ã‚Šç„¡åŠ¹)ã€‚")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("setsockopt(<sockfd>, SOL_SOCKET, SO_KEEPALIVE, [1], 4)\n")])])]),a("p",[t._v("â€» ç¬¬ 3 å¼•æ•°ãŒ "),a("code",[t._v("[0]")]),t._v(" ã®å ´åˆã€ãã‚Œã¯æ˜ç¤ºçš„ãªç„¡åŠ¹åŒ–ã‚’æ„å‘³ã—ã¾ã™ã€‚")]),t._v(" "),a("h3",{attrs:{id:"socket-ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#socket-ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«"}},[t._v("#")]),t._v(" socket ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«")]),t._v(" "),a("p",[t._v("Linux ä¸¦ã³ã« Windows ã§ã¯ã€TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ãŸã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ socket ã¨å‘¼ã°ã‚Œã‚‹ç‰¹æ®Šãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™ã€‚ä¾‹ãˆã°ã€Python3 ã§ (socket ã‚’é–‹ã„ã¦) ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œã‚‹æ™‚ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã§ã—ã‚‡ã†ã€‚")]),t._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" socket\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" time\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AF_INET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SOCK_STREAM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("connect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8.8.8.8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("53")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("å®Ÿéš›ã«ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã¨ã€("),a("code",[t._v("socket.sendall")]),t._v(" ã‚„ "),a("code",[t._v("socket.recv")]),t._v(" ãŒãªã„ã®ã§) ä½•ã‚‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€å—ä¿¡ã™ã‚‹ã“ã¨ã¯ç„¡ã„ (e.g. HTTP ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å‰‡ã£ã¦ã„ãªã„) ã®ã§ã™ãŒã€TCP ã® 3way handshake ã‚„ã‚¯ãƒ­ãƒ¼ã‚ºã®å‡¦ç†ã¯æ­£å¸¸ã«è¡Œãˆã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" tcpdump "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8 port "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("53")]),t._v(" -ni any\ntcpdump: verbose output suppressed, use -v or -vv "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" full protocol decode\nlistening on any, link-type LINUX_SLL "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Linux cooked"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", capture size "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("262144")]),t._v(" bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":12:47.319493 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5.50528 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8.53: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("464911782")]),t._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64240")]),t._v(", options "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mss "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1460")]),t._v(",sackOK,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3113655258")]),t._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(",nop,wscale "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":12:47.321744 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8.53 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5.50528: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("S."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2773628164")]),t._v(", ack "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("464911783")]),t._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")]),t._v(",\noptions "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mss "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1430")]),t._v(",sackOK,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1138427843")]),t._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3113655258")]),t._v(",nop,wscale "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":12:47.321781 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5.50528 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8.53: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", ack "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("502")]),t._v(", options "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nop,nop,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3113655261")]),t._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1138427843")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":12:47.321963 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5.50528 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8.53: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("F."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", ack "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("502")]),t._v(", options "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nop,nop,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3113655261")]),t._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1138427843")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":12:47.323556 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8.53 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5.50528: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("F."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", ack "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("256")]),t._v(", options "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nop,nop,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1138427846")]),t._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3113655261")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":12:47.323571 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5.50528 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8.53: Flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", ack "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", win "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("502")]),t._v(", options "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nop,nop,TS val "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3113655262")]),t._v(" ecr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1138427846")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),a("p",[t._v("ã¾ãŸã€ã©ã®ã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ç™ºè¡Œã—ã¦ã„ã‚‹ã‹ã€ã¨ã„ã†ç‚¹ã‚‚æŠ‘ãˆã¦ãŠãã¾ã—ã‚‡ã†ã€‚ãªãœãªã‚‰ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®è¦æ±‚ã‚’ã‚«ãƒ¼ãƒãƒ«ãŒå—ã‘å–ã‚‹å”¯ä¸€ã®æ–¹æ³•ã§ã‚ã‚Šã€å¾Œã«è¦‹ã‚‹ã‚ˆã†ã«ã€"),a("strong",[t._v("ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«æ¬¡ç¬¬ã§ TCP KeepAlive ã®æœ‰åŠ¹/ç„¡åŠ¹ãŒæ±ºå®šã•ã‚Œã‚‹")]),t._v("ç‚ºã§ã™ã€‚TCP ã‚’ç®¡ç†ã™ã‚‹ã®ã¯ Kernel ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¹ã‚¿ãƒƒã‚¯ãªã®ã§ã€TCP KeepAlive ã«é–¢ã™ã‚‹èª¿ç¯€å‘½ä»¤ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚«ãƒ¼ãƒãƒ«ã«å‡ºã•ãªã„ã¨ã„ã‘ãªã„ã®ã‚‚ç´å¾—ã§ã™ã­ã€‚")]),t._v(" "),a("p",[t._v("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒç™ºè¡Œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’èª¿ã¹ã‚‹ã«ã¯ "),a("code",[t._v("strace")]),t._v(" ã‚’ä½¿ã„ã¾ã™ã€‚")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strace")]),t._v(" -ff -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("trace")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("network python3 client.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("&1")]),t._v("\nsocket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AF_INET, SOCK_STREAM"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("SOCK_CLOEXEC, IPPROTO_IP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\nconnect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("sa_family"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("AF_INET, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sin_port")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("htons"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("53")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("sin_addr")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("inet_addr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8.8.8.8"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n+++ exited with "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" +++\n")])])]),a("p",[t._v("ã•ã¦ã€ã“ã‚Œã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ç¢ºç«‹ã•ã‚ŒãŸ TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã¯ã€TCP KeepAlive ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ")]),t._v(" "),a("p",[t._v("åˆè¦‹ã§åˆ¤å®šã™ã‚‹ã®ã¯ãªã‹ãªã‹é›£ã—ã„ã¨ã“ã‚ãªã®ã§ã€ã„ãã¤ã‹ã®æ—¢çŸ¥ã®çŸ¥è­˜ã‚’ä½¿ã£ã¦èª­ã¿è§£ã„ã¦è¡Œãã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã‹ã‚‰ä½¿ã†ã®ã¯ã€ä»¥ä¸‹ã® 2 ã¤ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ss")]),t._v(": ã‚½ã‚±ãƒƒãƒˆã«é–¢ã™ã‚‹çµ±è¨ˆé‡ã‚’å–å¾—ã™ã‚‹è¦³æ¸¬ãƒ„ãƒ¼ãƒ«ã€‚"),a("code",[t._v("-o (--options)")]),t._v(" ã‚’æŒ‡å®šã™ã‚‹ã¨ã€TCP KeepAlive ã®æœ‰ç„¡ã‚„ãã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤ºã—ã¦ãã‚Œã‚‹ã€‚")]),t._v(" "),a("li",[a("code",[t._v("curl")]),t._v(": æ§˜ã€…ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å¯¾å¿œã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€‚"),a("code",[t._v("--no-keepalive")]),t._v(" ã‚’æŒ‡å®šã™ã‚‹ã¨ TCP KeepAlive ã‚’ç„¡åŠ¹åŒ–ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã ã¨ TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚")])]),t._v(" "),a("h3",{attrs:{id:"ss-ã«ã‚ˆã‚‹-tcp-keepalive-åˆ¤å®š"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ss-ã«ã‚ˆã‚‹-tcp-keepalive-åˆ¤å®š"}},[t._v("#")]),t._v(" ss ã«ã‚ˆã‚‹ TCP KeepAlive åˆ¤å®š")]),t._v(" "),a("p",[t._v("è©¦ã—ã«å…ˆç¨‹ã® Python ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã€(TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã—ãŸ) curl ã®çµæœã‚’è¦‹æ¯”ã¹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ python3 client.py\n\n$ ss -tanoe "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dst 8.8.8.8'")]),t._v("\nState   Recv-Q   Send-Q   Local Address:Port    Peer Address:Port\nESTAB   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5:52686        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8:53  \nusers:"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("((")]),t._v('"python3"'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("pid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29357")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fd"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")])]),t._v(" uid:1000 ino:305411 sk:196 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://8.8.8.8:53 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# --no-keepalive ã‚’æŒ‡å®šã—ã¦ã„ãªã„ (TCP KeepAlive æœ‰åŠ¹åŒ–)")]),t._v("\n\n$ ss -tanoe "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dst 8.8.8.8'")]),t._v("\nState   Recv-Q   Send-Q   Local Address:Port    Peer Address:Port\nESTAB   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.3")]),t._v(".0.5:53326        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8:53   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\nusers:"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("((")]),t._v('"curl"'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("pid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30213")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("fd"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")])]),t._v(" timer:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("keepalive,1min,0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" uid:1000 ino:311003 sk:19a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[a("code",[t._v("curl")]),t._v(" ã®æ–¹ã«ã¯ã€timer ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã­ã€‚è©³ç´°ã¯ "),a("code",[t._v("ss(8)")]),t._v(" ã® man ã«è¼‰ã£ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã€timer ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ‰ç„¡ã§ TCP KeepAlive ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ¤å®šã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ESTABLISHED ãª TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ "),a("code",[t._v("ss -o")]),t._v(" ã§ç¢ºèªã—ãŸæ™‚ï¼š")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("timer:(keepalive, ...)")]),t._v(" ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€TCP KeepAlive ã¯æœ‰åŠ¹")]),t._v(" "),a("li",[a("code",[t._v("timer:(keepalive, ...)")]),t._v(" ãŒå­˜åœ¨ã—ãªã„å ´åˆã€TCP KeepAlive ã¯ç„¡åŠ¹")])]),t._v(" "),a("p",[t._v("ã¡ãªã¿ã«ã€timer ã®ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("timer:(<timer_name>,<expire_time>,<retrans>)\n\n<timer_name>\n        the name of the timer, there are five kind of timer names:\n        on : means one of these timers: TCP retrans timer, TCP early retrans timer and tail loss probe timer\n        keepalive: tcp keep alive timer\n        timewait: timewait stage timer\n        persist: zero window probe timer\n        unknown: none of the above timers\n\n<expire_time>\n        how long time the timer will expire\n\n<retrans>\n        how many times the retransmission occurred\n")])])]),a("ul",[a("li",[t._v("ref: "),a("a",{attrs:{href:"https://man7.org/linux/man-pages/man8/ss.8.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("man 8 ss"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"strace-ã«ã‚ˆã‚‹-tcp-keepalive-åˆ¤å®š"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#strace-ã«ã‚ˆã‚‹-tcp-keepalive-åˆ¤å®š"}},[t._v("#")]),t._v(" strace ã«ã‚ˆã‚‹ TCP KeepAlive åˆ¤å®š")]),t._v(" "),a("p",[t._v("æœ€åˆã® Python ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ TCP KeepAlive ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã‹ã£ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã“ã“ã¾ã§ãã‚Œã°ã‚ã¨ã‚‚ã†ä¸€æ¯ã§ã™ã€‚æœ€å¾Œã« "),a("code",[t._v("curl")]),t._v(" ãŒç™ºè¡Œã—ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’è¦‹ã‚‹ã ã‘ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€TCP KeepAlive ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®å·®åˆ†ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚")]),t._v(" "),a("div",{staticClass:"language-diff extra-class"},[a("pre",{pre:!0,attrs:{class:"language-diff"}},[a("code",[t._v("$ strace -e trace=network -o on.log curl http://8.8.8.8:53\n$ strace -e trace=network -o off.log curl http://8.8.8.8:53 --no-keepalive\n$ diff on.log off.log\n\n"),a("span",{pre:!0,attrs:{class:"token deleted-arrow deleted"}},[t._v('< setsockopt(3, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0\n< setsockopt(3, SOL_TCP, TCP_KEEPIDLE, [60], 4) = 0\n< setsockopt(3, SOL_TCP, TCP_KEEPINTVL, [60], 4) = 0\n< getsockname(3, {sa_family=AF_INET, sin_port=htons(57040), sin_addr=inet_addr("10.3.0.5")}, [128->16]) = 0\n')]),a("span",{pre:!0,attrs:{class:"token inserted-arrow inserted"}},[t._v('> getsockname(3, {sa_family=AF_INET, sin_port=htons(57012), sin_addr=inet_addr("10.3.0.5")}, [128->16]) = 0\n')])])])]),a("p",[t._v("TCP KeepAlive ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹æ™‚ã¯ "),a("code",[t._v("setsockopt")]),t._v(" ã§æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã­ã€‚strace ã§è¦‹ãŸæ™‚ã« "),a("code",[t._v("setsockopt(<sockfd>, SOL_SOCKET, SO_KEEPALIVE, [1], 4)")]),t._v("  ãŒå­˜åœ¨ã™ã‚Œã°æœ‰åŠ¹ã«ãªã£ã¦ãã†ãªåŒ‚ã„ã‚’æ„Ÿã˜ã¾ã™ ("),a("code",[t._v("TCP_KEEPIDLE")]),t._v(" ã¨ã‹ "),a("code",[t._v("TCP_KEEPINTVL")]),t._v(" ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å€¤ã®ä¸Šæ›¸ãã¨äºˆæƒ³ã§ãã¾ã™)ã€‚")]),t._v(" "),a("p",[t._v("Linux ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ãŸã¨ã“ã‚ã€ä¸‹è¨˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 4.2 ã«ã¾ã•ã«æ¢ã—ã¦ã„ãŸæƒ…å ±ãŒè¼‰ã£ã¦ã„ã¾ã—ãŸã€‚å—…è¦šã¯å½“ãŸã£ã¦ã„ã¾ã—ãŸ ğŸ‘")]),t._v(" "),a("blockquote",[a("p",[t._v("All you need to enable keepalive for a specific socket is to set the specific socket option on the socket itself. The prototype of the function is as follows:")]),t._v(" "),a("p",[t._v("int setsockopt(int s, int level, int optname,\nconst void *optval, socklen_t optlen)")]),t._v(" "),a("p",[t._v("The first parameter is the socket, previously created with the socket(2); the second one must be SOL_SOCKET, and the third must be SO_KEEPALIVE . The fourth parameter must be a boolean integer value, indicating that we want to enable the option, while the last is the size of the value passed before.")])]),t._v(" "),a("p",[a("a",{attrs:{href:"https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP Keepalive HOWTO"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("ç¬¬ 3 å¼•æ•°ã« "),a("code",[t._v("1")]),t._v(" (ã®å€¤ã‚’æ ¼ç´ã—ãŸ 4 byte ã®ãƒ¡ãƒ¢ãƒªã‚¹ãƒšãƒ¼ã‚¹ã¸ã®ãƒã‚¤ãƒ³ã‚¿) ã‚’æŒ‡å®šã™ã‚Œã°ã€ç¬¬ 1 å¼•æ•°ã«æŒ‡å®šã—ãŸ "),a("code",[t._v("sockfd")]),t._v(" ã® TCP KeepAlive ãŒæœ‰åŠ¹ã«ãªã‚‹ãã†ã§ã™ã€‚")]),t._v(" "),a("h2",{attrs:{id:"os-ã®ä»•çµ„ã¿ã§ãªã‚“ã¨ã‹ãªã‚‰ãªã„ï¼Ÿ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#os-ã®ä»•çµ„ã¿ã§ãªã‚“ã¨ã‹ãªã‚‰ãªã„ï¼Ÿ"}},[t._v("#")]),t._v(" OS ã®ä»•çµ„ã¿ã§ãªã‚“ã¨ã‹ãªã‚‰ãªã„ï¼Ÿ")]),t._v(" "),a("p",[a("code",[t._v("setsockopt")]),t._v(" ã§ã”ã«ã‚‡ã”ã«ã‚‡ã™ã‚Œã° TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã®ã¯ã‚ã‹ã£ãŸã€‚ã§ã‚‚ãã‚Œã ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã„ã˜ã‚‰ãªã„ã¨ã„ã‘ãªãã¦ã€ã‚ã‚“ã©ãã•ã„ã€‚å¾Œã¯è‡ªåˆ†ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿æœ‰ã—ã¦ã‚‹/æ”¹ä¿®ã§ãã‚‹ã¨ã¯é™ã‚‰ãªã„ã®ã§ã€ãªã‚“ã¨ã‹ OS ã®ä»•çµ„ã¿ã§ TCP KeepAlive æœ‰åŠ¹åŒ–ã§ããªã„ã®ï¼Ÿã¨æ€ã„ã¾ã™ã‚ˆã­ã€‚")]),t._v(" "),a("p",[t._v("ã—ã£ã‹ã‚Šã‚ã‚Šã¾ã—ãŸã€‚"),a("code",[t._v("LD_PRELOAD")]),t._v(" ã¨ã„ã†ã‚‚ã®ã ãã†ã§ã™ã€‚")]),t._v(" "),a("p",[a("code",[t._v("LD_PRELOAD")]),t._v(" ã¯ Linux ã®ç‰¹åˆ¥ãªç’°å¢ƒå¤‰æ•°ã§ã€å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª/å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ãƒ‘ã‚¹ã‚’å€¤ã¨ã—ã¦è¨­å®šã™ã‚‹ã¨ã€ä»»æ„ã®å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚ˆã‚Šã‚‚ãã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå„ªå…ˆçš„ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã«ç€ç›®ã—ãŸã®ãŒã€"),a("code",[t._v("libkeepalive.so")]),t._v(" ã§ã™ã€‚ã“ã‚Œã¯ã€"),a("code",[t._v("socket")]),t._v(" ã‚’é–‹ã„ãŸæ™‚ã«ä¸€ç·’ã« TCP KeepAlive ã‚‚æœ‰åŠ¹åŒ–ã™ã‚‹ã‚ˆã†ã«ã€TCP KeepAlive ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸã‚½ã‚±ãƒƒãƒˆæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚")]),t._v(" "),a("p",[a("a",{attrs:{href:"http://libkeepalive.sourceforge.net/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://libkeepalive.sourceforge.net/"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹ã¨ãã®åŠ¹æœãŒã‚ã‹ã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚")]),t._v(" "),a("h3",{attrs:{id:"ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ "}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ "}},[t._v("#")]),t._v(" ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP Keepalive HOWTO"),a("OutboundLink")],1),t._v(" ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 4.3 ã«ã‚ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ  "),a("code",[t._v("test")]),t._v(" ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("test")]),t._v(" ã¯ã€å˜ã« socket ã‚’ã²ã¨ã¤æ–°ãŸã«ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã™ã€‚")]),t._v(" "),a("li",[t._v("ãã®ç›´å¾Œã€socket ã® TCP KeepAlive è¨­å®š (SO_KEEPALIVE) å€¤ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚é€šå¸¸ã§ã‚ã‚Œã°ç„¡åŠ¹åŒ– ("),a("code",[t._v("0")]),t._v(") ã¨ãªã£ã¦ã„ã‚‹ã¯ãšã®å€¤ã§ã™ã­ã€‚")]),t._v(" "),a("li",[t._v("ãã®å¾Œã€"),a("code",[t._v("setsockopt")]),t._v(" ã‚’ä½¿ã£ã¦ã€æ˜ç¤ºçš„ã« TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚")]),t._v(" "),a("li",[t._v("å†åº¦ SO_KEEPALIVE ã®ç¾åœ¨å€¤ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚æœ€å¾Œã«ã¯æœ‰åŠ¹ ("),a("code",[t._v("1")]),t._v(") ã¨ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v("EOF "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("test.c\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#include <stdio.h>")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#include <stdlib.h>")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#include <unistd.h>")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#include <sys/types.h>")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#include <sys/socket.h>")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#include <netinet/in.h>")]),t._v("\n\nint "),a("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   int s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   int optval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   socklen_t optlen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sizeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("optval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("((")]),t._v("s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" socket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("PF_INET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SOCK_STREAM"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IPPROTO_TCP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      perror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"socket()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EXIT_FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n   if"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("getsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s, SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("optval, "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("optlen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      perror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getsockopt()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EXIT_FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   printf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SO_KEEPALIVE is %s'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("optval ? "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ON"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OFF"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   optval "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   optlen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sizeof"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("optval"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   if"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("setsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s, SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("optval, optlen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      perror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"setsockopt()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EXIT_FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   printf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SO_KEEPALIVE set on socket'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   if"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("getsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s, SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("optval, "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("optlen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      perror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getsockopt()"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EXIT_FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   printf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SO_KEEPALIVE is %s'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("optval ? "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ON"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OFF"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   exit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("EXIT_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nEOF\n\n$ gcc -o "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" test.c\n\n$ ./test\nSO_KEEPALIVE is OFF\nSO_KEEPALIVE "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" on socket\nSO_KEEPALIVE is ON\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strace")]),t._v(" -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("trace")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("network ./test\nsocket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AF_INET, SOCK_STREAM, IPPROTO_TCP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\ngetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nSO_KEEPALIVE is OFF\nsetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nSO_KEEPALIVE "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" on socket\ngetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nSO_KEEPALIVE is ON\n")])])]),a("p",[t._v("ä½•ã®å¤‰å“²ã‚‚ãªã„æœŸå¾…é€šã‚Šã®å‹•ä½œã§ã™ã€‚ç¹°ã‚Šè¿”ã—ã«ãªã‚Šã¾ã™ãŒã€"),a("code",[t._v("setsockopt")]),t._v(" ã§ "),a("code",[t._v("SO_KEEPALIVE")]),t._v(" ã‚’ 1 ã«ã‚»ãƒƒãƒˆã—ãªã„é™ã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ TCP KeepAlive ã¯ç„¡åŠ¹ã®ã¾ã¾ã§ã™ã€‚")]),t._v(" "),a("h3",{attrs:{id:"libkeepalive-ã‚ã‚Šã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ "}},[a("a",{staticClass:"header-anchor",attrs:{href:"#libkeepalive-ã‚ã‚Šã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ "}},[t._v("#")]),t._v(" libkeepalive ã‚ã‚Šã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ")]),t._v(" "),a("p",[t._v("ç¶šã„ã¦ "),a("code",[t._v("libkeepalive.so")]),t._v(" ã‚’ã‹ã¾ã—ã¦ã¿ã‚‹ã¨ã©ã†ãªã‚‹ã‹ã€‚ä»¥ä¸‹ã®é€šã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œãŒå¤‰åŒ–ã—ã¾ã™ã€‚")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v("  https://excellmedia.dl.sourceforge.net/project/libkeepalive/libkeepalive/0.3/libkeepalive-0.3.tar.gz\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -xzvf libkeepalive-0.3.tar.gz\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" libkeepalive-0.3\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" libkeepalive.so /usr/lib/\n\n$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("LD_PRELOAD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/lib/libkeepalive.so ./test\nSO_KEEPALIVE is ON\nSO_KEEPALIVE "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" on socket\nSO_KEEPALIVE is ON\n\n$ $ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("LD_PRELOAD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/lib/libkeepalive.so "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strace")]),t._v(" -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("trace")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("network ./test\nsocket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AF_INET, SOCK_STREAM, IPPROTO_TCP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\nsetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\ngetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nSO_KEEPALIVE is ON\nsetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nSO_KEEPALIVE "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" on socket\ngetsockopt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(", SOL_SOCKET, SO_KEEPALIVE, "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nSO_KEEPALIVE is ON\n+++ exited with "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" +++\n")])])]),a("p",[t._v("å…ˆç¨‹ã¨é•ã„ "),a("code",[t._v("setsockopt(3, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0")]),t._v(" ãŒ (çŸ¥ã‚‰ãªã„é–“ã«) æŒ¿å…¥ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒå…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å·®ã—æ›¿ãˆã«ã‚ˆã‚‹åŠ¹æœã§ã™ã€‚ãŸã ã—ã€"),a("code",[t._v("LD_PRELOAD")]),t._v(" ã‚’ä½¿ã†ã¨ã€ã‚¢ãƒ—ãƒªä¸Šã§é–‹ã„ãŸå…¨ã¦ã® socket ã§ TCP KeepAlive ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ã®ã§ã€ãã®ç‚¹ã¯é…æ…®ã—ãªãã¦ã¯ãªã‚Šã¾ã›ã‚“ã€‚")]),t._v(" "),a("h2",{attrs:{id:"ã¾ã¨ã‚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ã¾ã¨ã‚"}},[t._v("#")]),t._v(" ã¾ã¨ã‚")]),t._v(" "),a("p",[t._v("TCP ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç¢ºç«‹æ™‚ã«ç™ºè¡Œã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä½œã‚Šæ–¹ã‚„ã‚³ãƒãƒ³ãƒ‰ã®æŒ‡å®šæ–¹æ³•ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€"),a("code",[t._v("setsockopt")]),t._v("  ãŒ TCP KeepAlive ã«é–¢ã‚ã‚‹é‡è¦ãªã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’è¦‹ã¦ãã¾ã—ãŸã€‚æœ€çµ‚çš„ã« "),a("code",[t._v("setsockopt")]),t._v(" ã‚’ã‚«ãƒ¼ãƒãƒ«ã«é€ã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã«å¤‰ã‚ã‚Šã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å·®ã—æ›¿ãˆãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ ("),a("code",[t._v("libkeepalive")]),t._v(") ã«ã‚ˆã£ã¦ã€ä»»æ„ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å¼·åˆ¶çš„ã« TCP KeepAlive ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹æŠ€è¡“ã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸã€‚"),a("code",[t._v("nc")]),t._v(" ã®ã‚ˆã†ãª TCP KeepAlive ã«å¯¾å¿œã—ã¦ã„ãªã„ã‚¢ãƒ—ãƒªã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã®ã«ä½¿ãˆãã†ã§ã™ã€‚")]),t._v(" "),a("h2",{attrs:{id:"å‚è€ƒ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#å‚è€ƒ"}},[t._v("#")]),t._v(" å‚è€ƒ")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://tldp.org/HOWTO/html_single/TCP-Keepalive-HOWTO/",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCP Keepalive HOWTO"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.microsoft.com/ja-jp/windows-hardware/drivers/network/so-keepalive",target:"_blank",rel:"noopener noreferrer"}},[t._v("SO_KEEPALIVE - Windows drivers | Microsoft Docs"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://medium.com/@rajivsharma.2205/enable-tcp-keepalive-on-redis-cluster-bus-153128e412fa",target:"_blank",rel:"noopener noreferrer"}},[t._v("Enable TCP keepalive on Redis cluster bus (gossip inside cluster) | by Rajivsharma | Medium"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://kazuhira-r.hatenablog.com/entry/2020/02/27/002840",target:"_blank",rel:"noopener noreferrer"}},[t._v("Linuxã®TCP Keep-Aliveã‚’ç¢ºèªã™ã‚‹ - CLOVERğŸ€"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://man7.org/linux/man-pages/man8/ss.8.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ss(8) - Linux manual page"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://tech.tier4.jp/entry/2021/03/10/160000",target:"_blank",rel:"noopener noreferrer"}},[t._v("eBPFã‚„LD_PRELOADã‚’åˆ©ç”¨ã—ãŸå…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é–¢æ•°ãƒ•ãƒƒã‚¯ - Tier IV Tech Blog"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://quickhack.net/nom/blog/2018-01-19-enable-tcp-keepalive-of-macos-and-linux-in-ruby.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Enable TCP keepalive of macOS and Linux in Ruby"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://qiita.com/developer-kikikaikai/items/f6f87b2d1d7c3e14fb52",target:"_blank",rel:"noopener noreferrer"}},[t._v("æ—¢å­˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®é–¢æ•°ã‚’æ›¸ãæ›ãˆã‚‹ã€å¼·åŠ›ã§å±é™ºãªLinuxç’°å¢ƒå¤‰æ•°LD_PRELOAD - Qiita"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);