(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{217:function(s,t,a){"use strict";a.r(t);var e=a(1),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v('Brendan Gregg 氏のハンズオン ワークショップ "bpf-perf-workshop" より、SSH 経由のコマンドのパフォーマンスに関する課題 "lab2" をやってみました。')]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#課題"}},[s._v("課題")])]),a("li",[a("a",{attrs:{href:"#ラボ環境のセットアップ"}},[s._v("ラボ環境のセットアップ")])]),a("li",[a("a",{attrs:{href:"#before-ssh-経由コマンドのレイテンシ計測"}},[s._v("Before: ssh 経由コマンドのレイテンシ計測")])]),a("li",[a("a",{attrs:{href:"#調査方針"}},[s._v("調査方針")])]),a("li",[a("a",{attrs:{href:"#ログの収集"}},[s._v("ログの収集")]),a("ul",[a("li",[a("a",{attrs:{href:"#採取後の整形"}},[s._v("採取後の整形")])])])]),a("li",[a("a",{attrs:{href:"#分析"}},[s._v("分析")]),a("ul",[a("li",[a("a",{attrs:{href:"#cpu-観点での調査"}},[s._v("CPU 観点での調査")])]),a("li",[a("a",{attrs:{href:"#メモリ観点の調査"}},[s._v("メモリ観点の調査")])]),a("li",[a("a",{attrs:{href:"#ファイルシステム、i-o-観点の調査"}},[s._v("ファイルシステム、I/O 観点の調査")])]),a("li",[a("a",{attrs:{href:"#ネットワーク観点の調査"}},[s._v("ネットワーク観点の調査")])]),a("li",[a("a",{attrs:{href:"#一次見解"}},[s._v("一次見解")])])])]),a("li",[a("a",{attrs:{href:"#対応策"}},[s._v("対応策")]),a("ul",[a("li",[a("a",{attrs:{href:"#after-ssh-経由コマンドのレイテンシ計測"}},[s._v("After: ssh 経由コマンドのレイテンシ計測")])])])]),a("li",[a("a",{attrs:{href:"#まとめ"}},[s._v("まとめ")])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"課題"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#課題"}},[s._v("#")]),s._v(" 課題")]),s._v(" "),a("p",[s._v("今回の問題はこちら。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/brendangregg/bpf-perf-workshop/blob/master/lab2.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("bpf-perf-workshop/lab2.md at master · brendangregg/bpf-perf-workshop"),a("OutboundLink")],1)]),s._v(" "),a("blockquote",[a("p",[s._v("Problem Statement\nUnder load, it can take a few seconds to login to your lab system via SSH. Even when idle, it can take 1-2 seconds. Why does it take this long on an idle system, and how can this login time be reduced?")])]),s._v(" "),a("p",[s._v("負荷の高いシステムに SSH ログインするとき、ログインに時間がかかる (数秒要することもある) のはなぜ? という課題。")]),s._v(" "),a("h2",{attrs:{id:"ラボ環境のセットアップ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ラボ環境のセットアップ"}},[s._v("#")]),s._v(" ラボ環境のセットアップ")]),s._v(" "),a("p",[s._v("この課題は、負荷の高い (under load と表現される) ラボ環境を用意するところから始めなければならない。")]),s._v(" "),a("p",[s._v('"負荷" が意味するところがわからず戸惑ったが、ワークショップのスライドの文脈を読み解くに、おそらく '),a("code",[s._v("lab001")]),s._v(" を実行させた状態を under load を言っているに違いない。ということで、I/O 負荷を発生させる。なんとなく、"),a("code",[s._v("lab001")]),s._v(" を 2 つ起動させてみた。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@vm-ubuntu: ~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./bpf-perf-workshop/lab001 &")]),s._v("\nroot@vm-ubuntu: ~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./bpf-perf-workshop/lab001 &")]),s._v("\n")])])]),a("p",[s._v("いい感じに負荷みを感じている。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@vm-ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# uptime")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":37:40 up  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(":23,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" users,  load average: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.00")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.98")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.68")]),s._v("\n\nroot@vm-ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/pressure/io")]),s._v("\nsome "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("avg10")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("73.11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("avg60")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70.48")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("avg300")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("72.26")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("total")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11215650634")]),s._v("\nfull "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("avg10")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("73.10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("avg60")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("70.40")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("avg300")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("72.17")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("total")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11194499828")]),s._v("\n\nroot@vm-ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vmstat -S M 1")]),s._v("\nprocs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----\n r  b   swpd   "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v("   buff  cache   si   so    bi    bo   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("   cs us sy "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" wa st\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14816")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("791")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("680")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("124")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("93")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14816")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("791")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3824")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("579")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1960")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("97")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14816")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("791")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3920")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("619")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14816")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("791")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1920")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("741")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2059")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("97")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14816")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("791")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1756")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("645")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1909")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("93")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\nroot@vm-ubuntu:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iostat -xz 1")]),s._v("\n avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.50")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13.35")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86.15")]),s._v("\n\nDevice            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util\nsda              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("376.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4032.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("124.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24.80")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.70")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.63")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.72")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.66")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.00")]),s._v("\n")])])]),a("h2",{attrs:{id:"before-ssh-経由コマンドのレイテンシ計測"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#before-ssh-経由コマンドのレイテンシ計測"}},[s._v("#")]),s._v(" Before: ssh 経由コマンドのレイテンシ計測")]),s._v(" "),a("p",[s._v("手元のマシンから、ssh 経由の "),a("code",[s._v("echo hello")]),s._v(" にかかる時間を計測してみる。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("openjny@local-machine:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" openjny@"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("lab-machine"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -i id_rsa "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" hello\nhello\n\nreal    0m1.489s\nuser    0m0.057s\nsys     0m0.002s\n")])])]),a("p",[s._v("何回か計測してみたけど、たしかに "),a("code",[s._v("echo hello")]),s._v(" するだけで 1 ~ 数秒の時間がかかっていることがわかる。速いのか遅いのかよくわからないけど、eBPF を使ってボトルネックの特定と高速化を試みるとしましょう。")]),s._v(" "),a("h2",{attrs:{id:"調査方針"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#調査方針"}},[s._v("#")]),s._v(" 調査方針")]),s._v(" "),a("p",[s._v("今回の分析対象は「生存期間の短いプロセスであり、事前に調査対象の PID がわかっていない」というのが最大の特徴。そのため、数秒おきに stats を出すツール (e.g. vmstat) よりも、"),a("strong",[s._v("イベント ドリブンな")]),s._v("分析ツールが原因究明の鍵を握りそう。まずは、各コンポーネントで次の確認を進めたい。")]),s._v(" "),a("ul",[a("li",[s._v("CPU: プロセス/スレッドの誕生と終了、生存期間")]),s._v(" "),a("li",[s._v("メモリ: ページキャッシュの開放有無")]),s._v(" "),a("li",[s._v("ファイルシステム、I/O: 新たに "),a("code",[s._v("open")]),s._v(" された file の有無、ブロックデバイスへの(物理) I/O 発生状況")]),s._v(" "),a("li",[s._v("ネットワーク: ESTABLISH に要した時間、パケットドロップ/再送の量、トラフィックの発生状況")])]),s._v(" "),a("p",[s._v("使えそうな bcc のツールは以下の通り。")]),s._v(" "),a("ul",[a("li",[s._v("(cpu) execsnoop, exitsnoop")]),s._v(" "),a("li",[s._v("(memory) drsnoop, shmsnoop")]),s._v(" "),a("li",[s._v("(filesystem/io) filelife, biosnoop")]),s._v(" "),a("li",[s._v("(network) sofdsnoop, tcplife, tcpstates, tcpretrans")])]),s._v(" "),a("h2",{attrs:{id:"ログの収集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ログの収集"}},[s._v("#")]),s._v(" ログの収集")]),s._v(" "),a("p",[s._v("収集には以下の bash script を利用した。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BCC_TOOLS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/home/openjny/bcc/tools"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PREFIX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timeout 15s python3 -u"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pid")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -aux "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pid_sshd.log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cpu")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/execsnoop.py -xTU "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" execsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/exitsnoop.py --utc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" exitsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# memory")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/drsnoop.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" drsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/shmsnoop.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" shmsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fs/io")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/filelife.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filelife.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/biosnoop.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" biosnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# network")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/sofdsnoop.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" sofdsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/tcplife.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" tcplife.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/tcpstates.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" tcpstates.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PREFIX")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BCC_TOOLS")]),s._v("/tcpretrans.py "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" tcpretrans.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" tcpretrans.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" -lt "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Start..."')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wait")]),s._v("\n")])])]),a("p",[s._v("このスクリプトを作成している間に、bcc tools は既定で出力バッフを使うものが多く、リダイレクト時に正常に出力をパイプできない問題に遭遇。バッファが関係していそうなのはすぐわかったのだが、自分の環境では何故か "),a("code",[s._v("stdbuf")]),s._v(" が効かず、python 側のオプションを利用する方法を発見するまでに時間がかかってしまった…。そして、解決方法は issue ページにあったという 😢")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/iovisor/bcc/issues/905",target:"_blank",rel:"noopener noreferrer"}},[s._v("Stream Redirection Disables All Output · Issue #905 · iovisor/bcc"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("採取方法は簡単で、採取スクリプトを "),a("code",[s._v("sudo")]),s._v(' で実行して "Start..." が表示されてから、'),a("code",[s._v("ssh")]),s._v(" 経由のコマンド (遅い! と問題になっているやつ) をローカルから実行するだけ。")]),s._v(" "),a("h3",{attrs:{id:"採取後の整形"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#採取後の整形"}},[s._v("#")]),s._v(" 採取後の整形")]),s._v(" "),a("p",[s._v("採取した (イベント ドリブンな) ログはシステム全体を対象として計測されている。このままではログが多すぎるので、対象 "),a("code",[s._v("ssh")]),s._v(" コマンドの実行に関係のあるプロセスのログだけを抽出したい。まずは、"),a("code",[s._v("execsnoop")]),s._v(" の結果から、今回の事象によって "),a("code",[s._v("sshd")]),s._v(" から生成されたすべての (子孫) プロセスをリストアップする。")]),s._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# extract.py")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" pandas "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" pd\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" queue "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Queue\n\nEXECSNOOP_LOG "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./execsnoop.log'")]),s._v("\nROOT_PID "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1442")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("canonical_columns")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" c "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" cols "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("startswith"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Unnamed:'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\ndf_exec "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" pd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read_fwf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("EXECSNOOP_LOG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndf_exec "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" df_exec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("canonical_columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("df_exec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("columns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_child_pids")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" root_pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    q "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("put"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root_pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    child_pids "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("empty"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        pid "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        child_pids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("append"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        childs "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("df"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PPID'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PID'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" c "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" childs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("put"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" child_pids\n\npid_list "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_child_pids"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("df_exec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ROOT_PID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'|'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("join"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" p "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" pid_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("こいつを使って、フィルターが必要そうなログはフィルタリングをしておく。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pids")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("python3 extract.py"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" filtered\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" execsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$4")]),s._v(" ~ /'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pids")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/) { print } }'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filtered/execsnoop.log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" exitsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$3")]),s._v(" ~ /'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pids")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/) { print } }'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filtered/exitsnoop.log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" drsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v(" ~ /'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pids")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/) { print } }'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filtered/drsnoop.log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" shmsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v(" ~ /'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pids")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/) { print } }'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filtered/shmsnoop.log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" filelife.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v(" ~ /'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pids")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/) { print } }'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filtered/filelife.log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" biosnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$3")]),s._v(" ~ /'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pids")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/) { print } }'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" filtered/biosnoop.log\n")])])]),a("h2",{attrs:{id:"分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[s._v("#")]),s._v(" 分析")]),s._v(" "),a("h3",{attrs:{id:"cpu-観点での調査"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cpu-観点での調査"}},[s._v("#")]),s._v(" CPU 観点での調査")]),s._v(" "),a("p",[s._v("と、ここまで来て初めて気づいたが、フィルタリングが完全でないことが発覚。というのも、"),a("code",[s._v("execsnoop")]),s._v(" で検知できていないプロセスの複製/実行があることで、"),a("code",[s._v("sshd")]),s._v(" の子孫プロセスの列挙が不完全なものになってしまっていた。ただ、それでもいくつか重要なことがわかった。")]),s._v(" "),a("p",[s._v("まず、問題のコマンドが実行されたのは 14:28:58 であり、コマンド処理を担当するプロセスの PID は 27805 として生成されたことがわかる。時刻は大事な情報。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" execsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" /usr/sbin/sshd\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     sshd             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27805")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1442")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /usr/sbin/sshd -D -R\n")])])]),a("p",[s._v("次に、多数の (少なくとも 60 以上の) プロセスが生成されている。そしてここには "),a("code",[s._v("/etc/update-motd.d/*")]),s._v(" のプロセスが多く含まれる。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" filtered/execsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" filtered/execsnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'update-motd.d'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     run-parts        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27819")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /bin/run-parts --lsbsysinit /etc/update-motd.d\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     00-header        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27821")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/00-header\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("-help-text     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27825")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/10-help-text\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("-landscape-sy  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27826")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/50-landscape-sysinfo\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("-motd-news     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27832")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/50-motd-news\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v("-esm-announce  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27837")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/88-esm-announce\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v("-updates-avai  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27838")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/90-updates-available\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v("-contract-ua-  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27840")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/91-contract-ua-esm-status\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v("-release-upgr  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27841")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/91-release-upgrade\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("92")]),s._v("-unattended-u  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27849")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/92-unattended-upgrades\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("95")]),s._v("-hwe-eol       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27850")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/95-hwe-eol\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("97")]),s._v("-overlayroot   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27866")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/97-overlayroot\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98")]),s._v("-fsck-at-rebo  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27870")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/98-fsck-at-reboot\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98")]),s._v("-reboot-requi  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27876")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27820")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" /etc/update-motd.d/98-reboot-required\n")])])]),a("p",[a("code",[s._v("/etc/update-motd.d")]),s._v(" は Ubuntu での MOTD (message of the day) 用スクリプトが格納されているパスなので、ssh との関連性は確かに高い。ここでわかった重要な事実は、ssh 経由でコマンドを実行した場合でも、(表示はされないのにも関わらず) MOTD が実行されるということだ。これは無駄な処理だと考えられる。")]),s._v(" "),a("p",[s._v("生存期間の観点では特記すべき点は見られなかった。最も生存期間が長いプロセスは以下 3 つで、0.04 秒程度。ただ、それ以外は特に生存期間が長いプロセスはなく、まんべんなく短い実行時間のプロセスが多数発生していたと考えるのが良さそう。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" filtered/exitsnoop.log\nTIME-UTC     PCOMM            PID    "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("   TID    AGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  EXIT_CODE\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58.722 lsb_release      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27843")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27842")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27843")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.04")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58.722 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cut")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27844")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27842")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27844")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.04")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58.722 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("91")]),s._v("-release-upgr  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27842")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27841")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27842")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.04")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])])]),a("h3",{attrs:{id:"メモリ観点の調査"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#メモリ観点の調査"}},[s._v("#")]),s._v(" メモリ観点の調査")]),s._v(" "),a("p",[s._v("特に仮想メモリの飽和は観測されていないので、一旦問題ないと見なしてよいと思う。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" drsnoop.log\nCOMM           PID     LAT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ms"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" PAGES\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" shmsnoop.log\nPID    COMM                SYS              RET AR\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dmesg")]),s._v(" -T "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'oom|Out of memory'")]),s._v("\n")])])]),a("h3",{attrs:{id:"ファイルシステム、i-o-観点の調査"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ファイルシステム、i-o-観点の調査"}},[s._v("#")]),s._v(" ファイルシステム、I/O 観点の調査")]),s._v(" "),a("p",[s._v("まずは VFS で作成され削除された file 一覧を見てみる。"),a("code",[s._v("systemd")]),s._v(" でログイン時に生成されるものくらいしかなさそう。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" filelife.log\nTIME     PID    COMM             AGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  FILE\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27865")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    tmp.2mxHTbBPCU\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      systemd          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.29")]),s._v("    session-1245.scope\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1352")]),s._v("   systemd-logind   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1245")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("469")]),s._v("    systemd-journal  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(":339183\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("469")]),s._v("    systemd-journal  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.29")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(":339144\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      systemd          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.30")]),s._v("    user-1001.slice\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":28:58 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1352")]),s._v("   systemd-logind   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v("\n")])])]),a("p",[s._v("物理デバイスへの I/O も存在しない。ファイルの read や write で時間がかかってるのではないと考えられる。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" filtered/biosnoop.log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 念の為、目 grep で非対象 PID を除外して調査も実施")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" biosnoop.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ if ("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$3")]),s._v(" !~ /0|385|17836|17841|17829/) { print } }'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定常的に物理 I/O を発生させている PID を列挙するには以下を実行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tmp=$(mktemp)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# timeout 5s biosnoop.py > $tmp")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat $tmp | awk '{print $3}' | sed '1d' | sort | uniq | paste -sd'|'")]),s._v("\n")])])]),a("h3",{attrs:{id:"ネットワーク観点の調査"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ネットワーク観点の調査"}},[s._v("#")]),s._v(" ネットワーク観点の調査")]),s._v(" "),a("p",[s._v("tcplife で TCP コネクション確立/終了のライフサイクルを見てみる。22 ポートとの通信が一つ存在した。送受信バイト数もそれぞれ 2 KB と少なめ。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" tcplife.log\nPID   COMM       LADDR           LPORT RADDR           RPORT TX_KB RX_KB MS\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     swapper/3  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.4        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("local-ip-addr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4146")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("659.94")]),s._v("\n")])])]),a("p",[s._v("ここで、生成されているプロセス数がここまで多いと、他にも通信を発生させてるプロセスはあるのでは? という疑問が発生。このログからだけだとなんとも言えないが、何度か "),a("code",[s._v("tcplife")]),s._v(" のログをとってると、当該コマンドを実行して発生する TCP コネクションは 1 本だけであることがわかった。安心して、この TCP コネクションについて調査を進めるとする。")]),s._v(" "),a("p",[s._v("SYN を送ってから ESTAB になるまでの時間 (3-way handshake latency) は 0.012 秒。全く問題ない。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" tcpstates.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ffff8cf3ab844ec0 \n\nSKADDR           C-PID C-COMM     LADDR           LPORT RADDR           RPORT OLDSTATE    -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" NEWSTATE\nffff8cf3ab844ec0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     swapper/3  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     LISTEN      -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" SYN_RECV    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.000")]),s._v("\nffff8cf3ab844ec0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     swapper/3  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.4        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("126.149")]),s._v(".198.88  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4146")]),s._v("  SYN_RECV    -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ESTABLISHED "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.012")]),s._v("\nffff8cf3ab844ec0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27805")]),s._v(" sshd       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.4        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("126.149")]),s._v(".198.88  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4146")]),s._v("  ESTABLISHED -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" FIN_WAIT1   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("613.626")]),s._v("\nffff8cf3ab844ec0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     swapper/3  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.4        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("126.149")]),s._v(".198.88  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4146")]),s._v("  FIN_WAIT1   -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" CLOSING     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.181")]),s._v("\nffff8cf3ab844ec0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     swapper/3  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.4        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("126.149")]),s._v(".198.88  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4146")]),s._v("  CLOSING     -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" CLOSE       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("35.128")]),s._v("\n")])])]),a("p",[s._v("再送も存在していないので、ネットワーク観点でボトルネックの兆候は見られない。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" tcpretrans.log\nTracing retransmits "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". Hit Ctrl-C to end\nTIME     PID    IP LADDR:LPORT          T"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" RADDR:RPORT          STATE\n")])])]),a("h3",{attrs:{id:"一次見解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一次見解"}},[s._v("#")]),s._v(" 一次見解")]),s._v(" "),a("p",[s._v("当該コマンドは、仮想メモリ、ファイルシステム、I/O、ネットワークの観点ではボトルネックとなる程の処理を観測していない。最も可能性があるのは、大量にプロセスが生成されていることで、特に motd によって無駄なログイン処理が発生していることが示唆された。")]),s._v(" "),a("h2",{attrs:{id:"対応策"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#対応策"}},[s._v("#")]),s._v(" 対応策")]),s._v(" "),a("p",[a("code",[s._v("systemd")]),s._v(" の動作を調べるのは時間がかかりそうだったので、"),a("code",[s._v("/etc/update-motd.d")]),s._v(" 自体を削除するという単純な方法で対応をしてみる。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("root@vm-ubuntu:/etc"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /etc/update-motd.d/ /etc/update-motd.d.old")]),s._v("\n")])])]),a("h3",{attrs:{id:"after-ssh-経由コマンドのレイテンシ計測"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#after-ssh-経由コマンドのレイテンシ計測"}},[s._v("#")]),s._v(" After: ssh 経由コマンドのレイテンシ計測")]),s._v(" "),a("p",[s._v("対応後のコマンド実行レイテンシを何度か計測してみた。確かに 1 秒以上時間がかかるようなことはなくなり、改善が見られた。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("openjny@local-machine:~$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" openjny@"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("lab-machine"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -i id_rsa "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" hello\nhello\n\nreal    0m0.598s\nuser    0m0.034s\nsys     0m0.012s\n")])])]),a("p",[s._v("また、"),a("code",[s._v("execsnoop")]),s._v(" で実行されるプロセス数をカウントしてみると、対応前 60 以上あった子孫プロセスが、10 程度に抑えられていることも確認できた。")]),s._v(" "),a("h2",{attrs:{id:"まとめ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#まとめ"}},[s._v("#")]),s._v(" まとめ")]),s._v(" "),a("p",[s._v("今回の課題では、非常に生存時間が短く、かつ事前にわかっているのは "),a("code",[s._v("fork")]),s._v(" 元のプロセス ID だけ、というアプリケーションのレイテンシを増加させている原因を調査しました。WEB アプリケーションへの GET 要求等、ネットワーク越しの処理はおそらくこのようなシナリオに該当するのだろう。")]),s._v(" "),a("p",[s._v("そして、"),a("code",[s._v("strace")]),s._v(" や "),a("code",[s._v("tcpdump")]),s._v(" 等が使えないセンシティブなサーバー環境でも、コンポーネントごとにワークロード計測ができることを確認できました。十分とは言えないかもしれないけど、実際にレイテンシを削減することのできる対応を考えつくことが出来たので、最低限のところまでは対応できたと思います。")]),s._v(" "),a("p",[s._v("ただ、"),a("code",[s._v("systemd")]),s._v(" の動作がわかっていればよりプロセス間の関係、生成されたプロセスの意味が解釈しやすかったのだろうと思うと、やはり内部アーキテクチャを知っていることは重要であることを改めて感じた。また、今回は bcc だけで乗り切ったけど、"),a("code",[s._v("bpftrace")]),s._v(" でだけ提供されているネットワーク系ツール等も発見したので、今後活用していきたい。")])])}),[],!1,null,null,null);t.default=n.exports}}]);